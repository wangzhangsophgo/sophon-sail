

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5.8. sail.Bmcv &mdash; SOPHON-SAIL 3.10.2
 文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=9080cc91"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/translations.js?v=beaddf03"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="5.9. sail.Decoder" href="sail.Decoder.html" />
    <link rel="prev" title="5.7. sail.BMImage" href="sail.BMImage.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            SOPHON-SAIL
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">目录</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../1_disclaimer.html">1. 声明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_sail.html">2. SAIL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_build.html">3. 编译安装指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_module_cpp.html">4. SAIL C++ API 参考</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../5_module_python.html">5. SAIL Python API 参考</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Basicfunction.html">5.1. Basic function</a></li>
<li class="toctree-l2"><a class="reference internal" href="0_enum_type/enum_index.html">5.2. SAIL 枚举类型</a></li>
<li class="toctree-l2"><a class="reference internal" href="sail.Handle.html">5.3. sail.Handle</a></li>
<li class="toctree-l2"><a class="reference internal" href="sail.Tensor.html">5.4. sail.Tensor</a></li>
<li class="toctree-l2"><a class="reference internal" href="sail.Engine.html">5.5. sail.Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="sail.EngineLLM.html">5.6. sail.EngineLLM</a></li>
<li class="toctree-l2"><a class="reference internal" href="sail.BMImage.html">5.7. sail.BMImage</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.8. sail.Bmcv</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#init">5.8.1. __init__</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bm-image-to-tensor">5.8.2. bm_image_to_tensor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tensor-to-bm-image">5.8.3. tensor_to_bm_image</a></li>
<li class="toctree-l3"><a class="reference internal" href="#crop-and-resize">5.8.4. crop_and_resize</a></li>
<li class="toctree-l3"><a class="reference internal" href="#crop">5.8.5. crop</a></li>
<li class="toctree-l3"><a class="reference internal" href="#resize">5.8.6. resize</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vpp-crop-and-resize">5.8.7. vpp_crop_and_resize</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vpp-crop-and-resize-padding">5.8.8. vpp_crop_and_resize_padding</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vpp-crop">5.8.9. vpp_crop</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vpp-resize">5.8.10. vpp_resize</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vpp-resize-padding">5.8.11. vpp_resize_padding</a></li>
<li class="toctree-l3"><a class="reference internal" href="#warp">5.8.12. warp</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-to">5.8.13. convert_to</a></li>
<li class="toctree-l3"><a class="reference internal" href="#yuv2bgr">5.8.14. yuv2bgr</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rectangle">5.8.15. rectangle</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fillrectangle">5.8.16. fillRectangle</a></li>
<li class="toctree-l3"><a class="reference internal" href="#imwrite">5.8.17. imwrite</a></li>
<li class="toctree-l3"><a class="reference internal" href="#imread">5.8.18. imread</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-handle">5.8.19. get_handle</a></li>
<li class="toctree-l3"><a class="reference internal" href="#crop-and-resize-padding">5.8.20. crop_and_resize_padding</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-format">5.8.21. convert_format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vpp-convert-format">5.8.22. vpp_convert_format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#puttext">5.8.23. putText</a></li>
<li class="toctree-l3"><a class="reference internal" href="#image-add-weighted">5.8.24. image_add_weighted</a></li>
<li class="toctree-l3"><a class="reference internal" href="#image-copy-to">5.8.25. image_copy_to</a></li>
<li class="toctree-l3"><a class="reference internal" href="#image-copy-to-padding">5.8.26. image_copy_to_padding</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nms">5.8.27. nms</a></li>
<li class="toctree-l3"><a class="reference internal" href="#drawpoint">5.8.28. drawPoint</a></li>
<li class="toctree-l3"><a class="reference internal" href="#warp-perspective">5.8.29. warp_perspective</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-bm-data-type">5.8.30. get_bm_data_type</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-bm-image-data-format">5.8.31. get_bm_image_data_format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#imdecode">5.8.32. imdecode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#imencode">5.8.33. imencode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fft">5.8.34. fft</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-yuv420p-to-gray">5.8.35. convert_yuv420p_to_gray</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mat-to-bm-image">5.8.36. mat_to_bm_image</a></li>
<li class="toctree-l3"><a class="reference internal" href="#watermark-superpose">5.8.37. watermark_superpose</a></li>
<li class="toctree-l3"><a class="reference internal" href="#polylines">5.8.38. polylines</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mosaic">5.8.39. mosaic</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gaussian-blur">5.8.40. gaussian_blur</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transpose">5.8.41. transpose</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sobel">5.8.42. Sobel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#drawlines">5.8.43. drawLines</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stft">5.8.44. stft</a></li>
<li class="toctree-l3"><a class="reference internal" href="#istft">5.8.45. istft</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bmcv-overlay">5.8.46. bmcv_overlay</a></li>
<li class="toctree-l3"><a class="reference internal" href="#faiss-indexflatl2">5.8.47. faiss_indexflatL2</a></li>
<li class="toctree-l3"><a class="reference internal" href="#faiss-indexflatip">5.8.48. faiss_indexflatIP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#faiss-indexpq-encode">5.8.49. faiss_indexPQ_encode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#faiss-indexpq-adc">5.8.50. faiss_indexPQ_ADC</a></li>
<li class="toctree-l3"><a class="reference internal" href="#faiss-indexpq-sdc">5.8.51. faiss_indexPQ_SDC</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="sail.Decoder.html">5.9. sail.Decoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="sail.MultiDecoder.html">5.10. sail.MultiDecoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="sail.Encoder.html">5.11. sail.Encoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="sail.PaddingAtrr.html">5.12. sail.PaddingAtrr</a></li>
<li class="toctree-l2"><a class="reference internal" href="sail.Blend.html">5.13. sail.Blend</a></li>
<li class="toctree-l2"><a class="reference internal" href="sail.Decoder_RawStream.html">5.14. sail.Decoder_RawStream</a></li>
<li class="toctree-l2"><a class="reference internal" href="sail.BMImageArray.html">5.15. sail.BMImageArray</a></li>
<li class="toctree-l2"><a class="reference internal" href="sail.bm_image.html">5.16. sail.bm_image</a></li>
<li class="toctree-l2"><a class="reference internal" href="sail.MultiEngine.html">5.17. sail.MultiEngine</a></li>
<li class="toctree-l2"><a class="reference internal" href="1_high_perform_interface/high_perform_index.html">5.18. SAIL Python 高性能接口</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../6_appendix.html">6. 附录</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SOPHON-SAIL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../5_module_python.html"><span class="section-number">5. </span>SAIL Python API 参考</a></li>
      <li class="breadcrumb-item active"><span class="section-number">5.8. </span>sail.Bmcv</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/module_python/sail.Bmcv.rst.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sail-bmcv">
<h1><span class="section-number">5.8. </span>sail.Bmcv<a class="headerlink" href="#sail-bmcv" title="Link to this heading"></a></h1>
<p>Bmcv封装了常用的图像处理接口, 支持硬件加速。</p>
<p><strong>实现接口硬件说明</strong></p>
<p>本文档中, 在BM1684/BM1684X上实现的接口, 负责其实现的硬件单元可能有不同情况(i.e. crop_and_resize在BM1684上由VPP+智能视觉深度学习处理器实现)。影响实现的硬件单元的因素如下:</p>
<ol class="arabic simple">
<li><p>输入图片/输出图片数量不大于16</p></li>
<li><p>图片无需按照原图比例进行缩放</p></li>
<li><p>输入图片/输出图片不为以下数据格式: DATA_TYPE_EXT_1N_BYTE_SIGNED DATA_TYPE_EXT_4N_BYTE DATA_TYPE_EXT_FLOAT32</p></li>
<li><p>输入的图片device memory不在DDR0上</p></li>
<li><p>输入图片格式不为FORMAT_YUV422P, 输出图片格式不为FORMAT_NV12或FORMAT_COMPRESSED, 并且输入图片格式-输出图片格式不为以下组合:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>input_format</p></th>
<th class="head"><p>output_format</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>FORMAT_RGBP_SEPARATE</p></td>
<td><p>FORMAT_ARGB_PACKED FORMAT_ABGR_PACKED</p></td>
</tr>
<tr class="row-odd"><td><p>FORMAT_BGRP_SEPARATE</p></td>
<td><p>FORMAT_ARGB_PACKED FORMAT_ABGR_PACKED</p></td>
</tr>
<tr class="row-even"><td><p>FORMAT_GRAY</p></td>
<td><p>FORMAT_YUV420P FORMAT_YUV422P FORMAT_YUV444P</p></td>
</tr>
<tr class="row-odd"><td><p>FORMAT_YUV420P</p></td>
<td><p>FORMAT_GRAY FORMAT_YUV422P FORMAT_YUV444P</p></td>
</tr>
<tr class="row-even"><td><p>FORMAT_YUV444P</p></td>
<td><p>FORMAT_GRAY</p></td>
</tr>
<tr class="row-odd"><td><p>FORMAT_COMPRESSED</p></td>
<td><p>FORMAT_GRAY FORMAT_YUV422P FORMAT_YUV444P</p></td>
</tr>
</tbody>
</table>
<p>当且仅当满足上述5个条件时, 接口实现硬件为&quot;VPP+智能视觉深度学习处理器&quot;的Bmcv接口会使用VPP; 否则, 将会使用智能视觉深度学习处理器，
智能视觉深度学习处理器仅支持最邻近插值（Nearest Interpolitan），如不满足上述使用VPP的条件且缩放算法为其它插值策略，将会报错。</p>
<section id="init">
<h2><span class="section-number">5.8.1. </span>__init__<a class="headerlink" href="#init" title="Link to this heading"></a></h2>
<p>初始化Bmcv</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>handle: sail.Handle</p></li>
</ul>
<p>指定Bmcv使用的设备句柄。</p>
</section>
<section id="bm-image-to-tensor">
<h2><span class="section-number">5.8.2. </span>bm_image_to_tensor<a class="headerlink" href="#bm-image-to-tensor" title="Link to this heading"></a></h2>
<p>将BMImage/BMImageArray转换为Tensor。</p>
<dl>
<dt><strong>接口形式1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">bm_image_to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明1:</strong></p>
<ul class="simple">
<li><p>image: sail.BMImage</p></li>
</ul>
<p>需要转换的图像数据。</p>
<p><strong>返回值说明1:</strong></p>
<ul class="simple">
<li><p>tensor: sail.Tensor</p></li>
</ul>
<p>返回转换后的Tensor。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">bm_image_to_tensor</span><span class="p">(</span><span class="n">BMimg</span><span class="p">)</span><span class="c1"># here is a sail.Tensor</span>
</pre></div>
</div>
</dd>
<dt><strong>接口形式2:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">bm_image_to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
        <span class="n">tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明2:</strong></p>
<ul class="simple">
<li><p>image: sail.BMImageArray</p></li>
</ul>
<p>输入参数。需要转换的图像数据。</p>
<ul class="simple">
<li><p>tensor: sail.Tensor</p></li>
</ul>
<p>输出参数。转换后的Tensor。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,(</span><span class="mi">1920</span><span class="p">,</span><span class="mi">1080</span><span class="p">),</span><span class="n">sail</span><span class="o">.</span><span class="n">Dtype</span><span class="o">.</span><span class="n">BM_FLOAT32</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">bm_image_to_tensor</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span><span class="n">tensor</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="tensor-to-bm-image">
<h2><span class="section-number">5.8.3. </span>tensor_to_bm_image<a class="headerlink" href="#tensor-to-bm-image" title="Link to this heading"></a></h2>
<p>将Tensor转换为BMImage/BMImageArray。</p>
<dl>
<dt><strong>接口形式1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">tensor_to_bm_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">tensor</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">bgr2rgb</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">layout</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;nchw&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明1:</strong></p>
<ul class="simple">
<li><p>tensor: sail.Tensor</p></li>
</ul>
<p>输入参数。待转换的Tensor。</p>
<ul class="simple">
<li><p>bgr2rgb: bool, default: False</p></li>
</ul>
<p>输入参数。是否进行图像的通道变换。</p>
<ul class="simple">
<li><p>layout: str, default: 'nchw'</p></li>
</ul>
<p>输入参数。输入Tensor的布局。</p>
<p><strong>返回值说明1:</strong></p>
<ul class="simple">
<li><p>image : sail.BMImage</p></li>
</ul>
<p>返回转换后的图像。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">bm_image_to_tensor</span><span class="p">(</span><span class="n">BMimg</span><span class="p">)</span><span class="c1"># here is a sail.Tensor</span>
    <span class="n">BMimg2</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">tensor_to_bm_image</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt><strong>接口形式2:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">tensor_to_bm_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">tensor</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="nb">format</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">Format</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明2:</strong></p>
<ul class="simple">
<li><p>tensor: sail.Tensor</p></li>
</ul>
<p>输入参数。待转换的Tensor。</p>
<ul class="simple">
<li><p>format: sail.Format</p></li>
</ul>
<p>输入参数。BMImage的像素格式。</p>
<p><strong>返回值说明2:</strong></p>
<ul class="simple">
<li><p>image : sail.BMImage</p></li>
</ul>
<p>返回转换后的图像。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">bm_image_to_tensor</span><span class="p">(</span><span class="n">BMimg</span><span class="p">)</span><span class="c1"># here is a sail.Tensor</span>
    <span class="n">BMimg2</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">tensor_to_bm_image</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">sail</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">FORMAT_BGR_PLANAR</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt><strong>接口形式3:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">tensor_to_bm_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">tensor</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
        <span class="n">bgr2rgb</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">layout</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;nchw&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明3:</strong></p>
<ul class="simple">
<li><p>tensor: sail.Tensor</p></li>
</ul>
<p>输入参数。待转换的Tensor。</p>
<ul class="simple">
<li><p>img : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>输出参数。返回转换后的图像。</p>
<ul class="simple">
<li><p>bgr2rgb: bool, default: False</p></li>
</ul>
<p>输入参数。是否进行图像的通道变换。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">bm_image_to_tensor</span><span class="p">(</span><span class="n">BMimg</span><span class="p">)</span><span class="c1"># here is a sail.Tensor</span>
    <span class="n">BMimg2</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">tensor_to_bm_image</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span><span class="n">BMimg2</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt><strong>接口形式4:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">tensor_to_bm_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">tensor</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
        <span class="nb">format</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">Format</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明4:</strong></p>
<ul class="simple">
<li><p>tensor: sail.Tensor</p></li>
</ul>
<p>输入参数。待转换的Tensor。</p>
<ul class="simple">
<li><p>img: sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>输出参数。返回转换后的图像。</p>
<ul class="simple">
<li><p>format: sail.Format</p></li>
</ul>
<p>输入参数。BMImage的像素格式。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">bm_image_to_tensor</span><span class="p">(</span><span class="n">BMimg</span><span class="p">)</span><span class="c1"># here is a sail.Tensor</span>
    <span class="n">BMimg2</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">tensor_to_bm_image</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span><span class="n">BMimg2</span><span class="p">,</span> <span class="n">sail</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">FORMAT_BGR_PLANAR</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="crop-and-resize">
<h2><span class="section-number">5.8.4. </span>crop_and_resize<a class="headerlink" href="#crop-and-resize" title="Link to this heading"></a></h2>
<p>对图片进行裁剪并resize。</p>
<p><strong>实现硬件</strong>
* BM1684: VPP+智能视觉深度学习处理器
* BM1684X: VPP</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">crop_and_resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
        <span class="n">crop_x0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">crop_y0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">crop_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">crop_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">resize_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">resize_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">resize_alg</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">bmcv_resize_algorithm</span><span class="o">=</span><span class="n">sail</span><span class="o">.</span><span class="n">bmcv_resize_algorithm</span><span class="o">.</span><span class="n">BMCV_INTER_NEAREST</span><span class="p">)</span>
            <span class="o">-&gt;</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>待处理的图像或图像数组。</p>
<ul class="simple">
<li><p>crop_x0 : int</p></li>
</ul>
<p>裁剪窗口在x轴上的起始点。</p>
<ul class="simple">
<li><p>crop_y0 : int</p></li>
</ul>
<p>裁剪窗口在y轴上的起始点。</p>
<ul class="simple">
<li><p>crop_w : int</p></li>
</ul>
<p>裁剪窗口的宽。</p>
<ul class="simple">
<li><p>crop_h : int</p></li>
</ul>
<p>裁剪窗口的高。</p>
<ul class="simple">
<li><p>resize_w : int</p></li>
</ul>
<p>图像resize的目标宽度。</p>
<ul class="simple">
<li><p>resize_h : int</p></li>
</ul>
<p>图像resize的目标高度。</p>
<ul class="simple">
<li><p>resize_alg : sail.bmcv_resize_algorithm</p></li>
</ul>
<p>图像resize的插值算法，默认为sail.bmcv_resize_algorithm.BMCV_INTER_NEAREST</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>返回处理后的图像或图像数组。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">BMimg3</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">crop_and_resize</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">BMimg</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span><span class="n">BMimg</span><span class="o">.</span><span class="n">height</span><span class="p">(),</span><span class="mi">640</span><span class="p">,</span><span class="mi">640</span><span class="p">,</span><span class="n">sail</span><span class="o">.</span><span class="n">bmcv_resize_algorithm</span><span class="o">.</span><span class="n">BMCV_INTER_NEAREST</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="crop">
<h2><span class="section-number">5.8.5. </span>crop<a class="headerlink" href="#crop" title="Link to this heading"></a></h2>
<p>对图像进行裁剪。</p>
<dl>
<dt><strong>接口形式1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
        <span class="n">crop_x0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">crop_y0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">crop_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">crop_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>待处理的图像或图像数组。</p>
<ul class="simple">
<li><p>crop_x0 : int</p></li>
</ul>
<p>裁剪窗口在x轴上的起始点。</p>
<ul class="simple">
<li><p>crop_y0 : int</p></li>
</ul>
<p>裁剪窗口在y轴上的起始点。</p>
<ul class="simple">
<li><p>crop_w : int</p></li>
</ul>
<p>裁剪窗口的宽。</p>
<ul class="simple">
<li><p>crop_h : int</p></li>
</ul>
<p>裁剪窗口的高。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>返回处理后的图像或图像数组。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">crop_x0</span><span class="p">,</span> <span class="n">crop_y0</span><span class="p">,</span> <span class="n">crop_w</span><span class="p">,</span> <span class="n">crop_h</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span>
    <span class="n">cropped_BMimg</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span> <span class="n">crop_x0</span><span class="p">,</span> <span class="n">crop_y0</span><span class="p">,</span> <span class="n">crop_w</span><span class="p">,</span> <span class="n">crop_h</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
<p>对图像进行裁剪,可从一张图上裁剪出多个小图</p>
<dl>
<dt><strong>接口形式2:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span>
        <span class="n">rects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[]]</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">]</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage</p></li>
</ul>
<p>待处理的图像。</p>
<ul class="simple">
<li><p>rects: list[list[]]</p></li>
</ul>
<p>[[crop_x0,crop_y0,crop_w0,crop_h0],[crop_x1,crop_y1,crop_w1,crop_h1]]</p>
<ul class="simple">
<li><p>crop_xi : int</p></li>
</ul>
<p>第i个裁剪窗口在x轴上的起始点。</p>
<ul class="simple">
<li><p>crop_yi : int</p></li>
</ul>
<p>第i个裁剪窗口在y轴上的起始点。</p>
<ul class="simple">
<li><p>crop_wi : int</p></li>
</ul>
<p>第i个裁剪窗口的宽。</p>
<ul class="simple">
<li><p>crop_hi : int</p></li>
</ul>
<p>第i个裁剪窗口的高。</p>
<p><strong>返回值说明1:</strong></p>
<ul class="simple">
<li><p>output : list[sail.BMImage]</p></li>
</ul>
<p>返回处理后的图像列表。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">rects</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">],</span>
        <span class="c1">#...more</span>
    <span class="p">]</span>
    <span class="n">cropped_images_list</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span> <span class="n">rects</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="resize">
<h2><span class="section-number">5.8.6. </span>resize<a class="headerlink" href="#resize" title="Link to this heading"></a></h2>
<p>对图像进行resize。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
        <span class="n">resize_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">resize_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">resize_alg</span><span class="p">:</span> <span class="n">bmcv_resize_algorithm</span> <span class="o">=</span> <span class="n">BMCV_INTER_NEAREST</span><span class="p">)</span>
    <span class="o">-&gt;</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>待处理的图像或图像数组。</p>
<ul class="simple">
<li><p>resize_w : int</p></li>
</ul>
<p>图像resize的目标宽度。</p>
<ul class="simple">
<li><p>resize_h : int</p></li>
</ul>
<p>图像resize的目标高度。</p>
<ul class="simple">
<li><p>resize_alg : sail.bmcv_resize_algorithm</p></li>
</ul>
<p>图像resize的插值算法，默认为sail.bmcv_resize_algorithm.BMCV_INTER_NEAREST</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>返回处理后的图像或图像数组。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">BMimg_resize</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span><span class="mi">640</span><span class="p">,</span><span class="mi">640</span><span class="p">,</span><span class="n">resize_alg</span><span class="o">=</span><span class="n">sail</span><span class="o">.</span><span class="n">bmcv_resize_algorithm</span><span class="o">.</span><span class="n">BMCV_INTER_NEAREST</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="vpp-crop-and-resize">
<h2><span class="section-number">5.8.7. </span>vpp_crop_and_resize<a class="headerlink" href="#vpp-crop-and-resize" title="Link to this heading"></a></h2>
<p>利用VPP硬件加速图片的裁剪与resize。</p>
<p><strong>实现硬件</strong>
* BM1684: VPP
* BM1684X: VPP</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">vpp_crop_and_resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
                <span class="n">crop_x0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">crop_y0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">crop_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">crop_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">resize_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">resize_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">resize_alg</span><span class="p">:</span> <span class="n">bmcv_resize_algorithm</span> <span class="o">=</span> <span class="n">BMCV_INTER_NEAREST</span><span class="p">)</span>
                <span class="o">-&gt;</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>待处理的图像或图像数组。</p>
<ul class="simple">
<li><p>crop_x0 : int</p></li>
</ul>
<p>裁剪窗口在x轴上的起始点。</p>
<ul class="simple">
<li><p>crop_y0 : int</p></li>
</ul>
<p>裁剪窗口在y轴上的起始点。</p>
<ul class="simple">
<li><p>crop_w : int</p></li>
</ul>
<p>裁剪窗口的宽。</p>
<ul class="simple">
<li><p>crop_h : int</p></li>
</ul>
<p>裁剪窗口的高。</p>
<ul class="simple">
<li><p>resize_w : int</p></li>
</ul>
<p>图像resize的目标宽度。</p>
<ul class="simple">
<li><p>resize_h : int</p></li>
</ul>
<p>图像resize的目标高度。</p>
<ul class="simple">
<li><p>resize_alg : sail.bmcv_resize_algorithm</p></li>
</ul>
<p>图像resize的插值算法，默认为sail.bmcv_resize_algorithm.BMCV_INTER_NEAREST</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>返回处理后的图像或图像数组。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">crop_x0</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">crop_y0</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">crop_w</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">crop_h</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">resize_w</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">resize_h</span> <span class="o">=</span> <span class="mi">300</span>

    <span class="n">resized_BMimg</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">vpp_crop_and_resize</span><span class="p">(</span>
        <span class="n">BMimg</span><span class="p">,</span>
        <span class="n">crop_x0</span><span class="p">,</span>
        <span class="n">crop_y0</span><span class="p">,</span>
        <span class="n">crop_w</span><span class="p">,</span>
        <span class="n">crop_h</span><span class="p">,</span>
        <span class="n">resize_w</span><span class="p">,</span>
        <span class="n">resize_h</span><span class="p">,</span>
        <span class="n">sail</span><span class="o">.</span><span class="n">bmcv_resize_algorithm</span><span class="o">.</span><span class="n">BMCV_INTER_NEAREST</span>
    <span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="vpp-crop-and-resize-padding">
<h2><span class="section-number">5.8.8. </span>vpp_crop_and_resize_padding<a class="headerlink" href="#vpp-crop-and-resize-padding" title="Link to this heading"></a></h2>
<p>利用VPP硬件加速图片的裁剪与resize，并padding到指定大小。</p>
<p><strong>实现硬件</strong>
* BM1684: VPP
* BM1684X: VPP</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">vpp_crop_and_resize_padding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
                    <span class="n">crop_x0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">crop_y0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">crop_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">crop_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">resize_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">resize_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">padding</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">PaddingAtrr</span><span class="p">,</span>
                    <span class="n">resize_alg</span><span class="p">:</span> <span class="n">bmcv_resize_algorithm</span> <span class="o">=</span> <span class="n">BMCV_INTER_NEAREST</span><span class="p">)</span>
                     <span class="o">-&gt;</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>待处理的图像或图像数组。</p>
<ul class="simple">
<li><p>crop_x0 : int</p></li>
</ul>
<p>裁剪窗口在x轴上的起始点。</p>
<ul class="simple">
<li><p>crop_y0 : int</p></li>
</ul>
<p>裁剪窗口在y轴上的起始点。</p>
<ul class="simple">
<li><p>crop_w : int</p></li>
</ul>
<p>裁剪窗口的宽。</p>
<ul class="simple">
<li><p>crop_h : int</p></li>
</ul>
<p>裁剪窗口的高。</p>
<ul class="simple">
<li><p>resize_w : int</p></li>
</ul>
<p>图像resize的目标宽度。</p>
<ul class="simple">
<li><p>resize_h : int</p></li>
</ul>
<p>图像resize的目标高度。</p>
<ul class="simple">
<li><p>padding : sail.PaddingAtrr</p></li>
</ul>
<p>padding的配置信息。</p>
<ul class="simple">
<li><p>resize_alg : sail.bmcv_resize_algorithm</p></li>
</ul>
<p>图像resize的插值算法，默认为sail.bmcv_resize_algorithm.BMCV_INTER_NEAREST</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>返回处理后的图像或图像数组。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">paddingatt</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">PaddingAtrr</span><span class="p">()</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_stx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_sty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_w</span><span class="p">(</span><span class="mi">640</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_h</span><span class="p">(</span><span class="mi">640</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_r</span><span class="p">(</span><span class="mi">114</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_g</span><span class="p">(</span><span class="mi">114</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_b</span><span class="p">(</span><span class="mi">114</span><span class="p">)</span>
    <span class="n">BMimg4</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">vpp_crop_and_resize_padding</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">BMimg</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span><span class="n">BMimg</span><span class="o">.</span><span class="n">height</span><span class="p">(),</span><span class="mi">640</span><span class="p">,</span><span class="mi">640</span><span class="p">,</span><span class="n">paddingatt</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="vpp-crop">
<h2><span class="section-number">5.8.9. </span>vpp_crop<a class="headerlink" href="#vpp-crop" title="Link to this heading"></a></h2>
<p>利用VPP硬件加速图片的裁剪。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">vpp_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
    <span class="n">crop_x0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">crop_y0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">crop_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">crop_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>待处理的图像或图像数组。</p>
<ul class="simple">
<li><p>crop_x0 : int</p></li>
</ul>
<p>裁剪窗口在x轴上的起始点。</p>
<ul class="simple">
<li><p>crop_y0 : int</p></li>
</ul>
<p>裁剪窗口在y轴上的起始点。</p>
<ul class="simple">
<li><p>crop_w : int</p></li>
</ul>
<p>裁剪窗口的宽。</p>
<ul class="simple">
<li><p>crop_h : int</p></li>
</ul>
<p>裁剪窗口的高。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>返回处理后的图像或图像数组。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">crop_x0</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">crop_y0</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">crop_w</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">crop_h</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">BMimg4</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">vpp_crop</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span><span class="n">crop_x0</span><span class="p">,</span><span class="n">crop_y0</span><span class="p">,</span><span class="n">crop_w</span><span class="p">,</span><span class="n">crop_h</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="vpp-resize">
<h2><span class="section-number">5.8.10. </span>vpp_resize<a class="headerlink" href="#vpp-resize" title="Link to this heading"></a></h2>
<p>利用VPP硬件加速图片的resize，采用最近邻插值算法。</p>
<dl>
<dt><strong>接口形式1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">vpp_resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
        <span class="n">resize_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">resize_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">resize_alg</span><span class="p">:</span> <span class="n">bmcv_resize_algorithm</span> <span class="o">=</span> <span class="n">BMCV_INTER_NEAREST</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明1:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>待处理的图像或图像数组。</p>
<ul class="simple">
<li><p>resize_w : int</p></li>
</ul>
<p>图像resize的目标宽度。</p>
<ul class="simple">
<li><p>resize_h : int</p></li>
</ul>
<p>图像resize的目标高度。</p>
<ul class="simple">
<li><p>resize_alg : sail.bmcv_resize_algorithm</p></li>
</ul>
<p>图像resize的插值算法，默认为sail.bmcv_resize_algorithm.BMCV_INTER_NEAREST</p>
<p><strong>返回值说明1:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>返回处理后的图像或图像数组。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">BMimg_resize</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">vpp_resize</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span><span class="mi">640</span><span class="p">,</span><span class="mi">640</span><span class="p">,</span><span class="n">resize_alg</span><span class="o">=</span><span class="n">sail</span><span class="o">.</span><span class="n">bmcv_resize_algorithm</span><span class="o">.</span><span class="n">BMCV_INTER_NEAREST</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt><strong>接口形式2:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">vpp_resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
       <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
       <span class="n">output</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
       <span class="n">resize_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
       <span class="n">resize_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
       <span class="n">resize_alg</span><span class="p">:</span> <span class="n">bmcv_resize_algorithm</span> <span class="o">=</span> <span class="n">BMCV_INTER_NEAREST</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明2:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>输入参数。待处理的图像或图像数组。</p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>输出参数。处理后的图像或图像数组。</p>
<ul class="simple">
<li><p>resize_w : int</p></li>
</ul>
<p>输入参数。图像resize的目标宽度。</p>
<ul class="simple">
<li><p>resize_h : int</p></li>
</ul>
<p>输入参数。图像resize的目标高度。</p>
<ul class="simple">
<li><p>resize_alg : sail.bmcv_resize_algorithm</p></li>
</ul>
<p>图像resize的插值算法，默认为sail.bmcv_resize_algorithm.BMCV_INTER_NEAREST</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">BMimg_resize</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">vpp_resize</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span><span class="n">BMimg_resize</span><span class="p">,</span><span class="mi">640</span><span class="p">,</span><span class="mi">640</span><span class="p">,</span><span class="n">resize_alg</span><span class="o">=</span><span class="n">sail</span><span class="o">.</span><span class="n">bmcv_resize_algorithm</span><span class="o">.</span><span class="n">BMCV_INTER_NEAREST</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="vpp-resize-padding">
<h2><span class="section-number">5.8.11. </span>vpp_resize_padding<a class="headerlink" href="#vpp-resize-padding" title="Link to this heading"></a></h2>
<p>利用VPP硬件加速图片的resize，并padding。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">vpp_resize_padding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
        <span class="n">resize_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">resize_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">padding</span><span class="p">:</span> <span class="n">PaddingAtrr</span><span class="p">,</span>
        <span class="n">resize_alg</span><span class="p">:</span> <span class="n">bmcv_resize_algorithm</span> <span class="o">=</span> <span class="n">BMCV_INTER_NEAREST</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>待处理的图像或图像数组。</p>
<ul class="simple">
<li><p>resize_w : int</p></li>
</ul>
<p>图像resize的目标宽度。</p>
<ul class="simple">
<li><p>resize_h : int</p></li>
</ul>
<p>图像resize的目标高度。</p>
<ul class="simple">
<li><p>padding : sail.PaddingAtrr</p></li>
</ul>
<p>padding的配置信息。</p>
<ul class="simple">
<li><p>resize_alg : sail.bmcv_resize_algorithm</p></li>
</ul>
<p>图像resize的插值算法，默认为sail.bmcv_resize_algorithm.BMCV_INTER_NEAREST</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>返回处理后的图像或图像数组。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>  <span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">paddingatt</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">PaddingAtrr</span><span class="p">()</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_stx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_sty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_w</span><span class="p">(</span><span class="mi">640</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_h</span><span class="p">(</span><span class="mi">640</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_r</span><span class="p">(</span><span class="mi">114</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_g</span><span class="p">(</span><span class="mi">114</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_b</span><span class="p">(</span><span class="mi">114</span><span class="p">)</span>
    <span class="n">BMimg4</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">vpp_resize_padding</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span><span class="mi">640</span><span class="p">,</span><span class="mi">640</span><span class="p">,</span><span class="n">paddingatt</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="warp">
<h2><span class="section-number">5.8.12. </span>warp<a class="headerlink" href="#warp" title="Link to this heading"></a></h2>
<p>对图像进行仿射变换。</p>
<p><strong>实现硬件</strong>
* BM1684: 智能视觉深度学习处理器
* BM1684X: 智能视觉深度学习处理器</p>
<dl>
<dt><strong>接口形式1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">warp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
    <span class="n">matrix</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">use_bilinear</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">similar_to_opencv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明1:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>待处理的图像或图像数组。</p>
<ul class="simple">
<li><p>matrix: 2d list</p></li>
</ul>
<p>2x3的仿射变换矩阵。</p>
<ul class="simple">
<li><p>use_bilinear: int</p></li>
</ul>
<p>是否使用双线性插值，默认为0使用最近邻插值，1为双线性插值</p>
<ul class="simple">
<li><p>similar_to_opencv: bool</p></li>
</ul>
<p>是否使用与opencv仿射变换对齐的接口</p>
<p><strong>返回值说明1:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>返回处理后的图像或图像数组。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">rotated_matrix</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.9996914396</span><span class="p">,</span><span class="o">-</span><span class="mf">0.02484</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mf">0.02484</span><span class="p">,</span><span class="mf">0.9996914396</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">BMimg6</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span> <span class="n">rotated_matrix</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt><strong>接口形式2:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">warp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
    <span class="n">matrix</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">use_bilinear</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">similar_to_opencv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明2:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>待处理的图像或图像数组。</p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>待返回的输出图像或图像数组。</p>
<ul class="simple">
<li><p>matrix: 2d list</p></li>
</ul>
<p>2x3的仿射变换矩阵。</p>
<ul class="simple">
<li><p>use_bilinear: int</p></li>
</ul>
<p>是否使用双线性插值，默认为0使用最近邻插值，1为双线性插值</p>
<ul class="simple">
<li><p>similar_to_opencv: bool</p></li>
</ul>
<p>是否使用与opencv仿射变换对齐的接口</p>
<p><strong>返回值说明2:</strong></p>
<p>如果成功返回0，否则返回非0值。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">rotated_matrix</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.9996914396</span><span class="p">,</span><span class="o">-</span><span class="mf">0.02484</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mf">0.02484</span><span class="p">,</span><span class="mf">0.9996914396</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span><span class="n">rotated_matrix</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="convert-to">
<h2><span class="section-number">5.8.13. </span>convert_to<a class="headerlink" href="#convert-to" title="Link to this heading"></a></h2>
<p>对图像进行线性变换。</p>
<p><strong>实现硬件</strong>
* BM1684: 智能视觉深度学习处理器
* BM1684X: VPP+智能视觉深度学习处理器</p>
<dl>
<dt><strong>接口形式1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">convert_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
    <span class="n">alpha_beta</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明1:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>待处理的图像或图像数组。</p>
<ul class="simple">
<li><p>alpha_beta: tuple</p></li>
</ul>
<p>分别为三个通道线性变换的系数((a0, b0), (a1, b1), (a2, b2))。</p>
<p><strong>返回值说明1:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>返回处理后的图像或图像数组。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">alpha_beta</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">BMimg5</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">convert_to</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span> <span class="n">alpha_beta</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt><strong>接口形式2:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">convert_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">,</span>
        <span class="n">alpha_beta</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明2:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>输入参数。待处理的图像或图像数组。</p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>输出参数。返回处理后的图像或图像数组。</p>
<ul class="simple">
<li><p>alpha_beta: tuple</p></li>
</ul>
<p>分别为三个通道线性变换的系数((a0, b0), (a1, b1), (a2, b2))。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">alpha_beta</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">BMimg5</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">convert_to</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span> <span class="n">BMimg5</span><span class="p">,</span><span class="n">alpha_beta</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="yuv2bgr">
<h2><span class="section-number">5.8.14. </span>yuv2bgr<a class="headerlink" href="#yuv2bgr" title="Link to this heading"></a></h2>
<p>将图像的格式从YUV转换为BGR。</p>
<p><strong>实现硬件</strong>
* BM1684: 智能视觉深度学习处理器+VPP
* BM1684X: VPP</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">yuv2bgr</span><span class="p">(</span><span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span><span class="p">)</span>
        <span class="o">-&gt;</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span> <span class="o">|</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImageArray</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>待转换的图像。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage | sail.BMImageArray</p></li>
</ul>
<p>返回转换后的图像。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">BMimg5</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">yuv2bgr</span><span class="p">(</span><span class="n">BMimg</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="rectangle">
<h2><span class="section-number">5.8.15. </span>rectangle<a class="headerlink" href="#rectangle" title="Link to this heading"></a></h2>
<p>在图像上画一个矩形框。</p>
<p><strong>实现硬件</strong>
* BM1684: 智能视觉深度学习处理器
* BM1684X: VPP</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">rectangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span>
        <span class="n">x0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">y0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
        <span class="n">thickness</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rectangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">bm_image</span><span class="p">,</span>
        <span class="n">x0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">y0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
        <span class="n">thickness</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>image : sail.BMImage 或 sail.bm_image</p></li>
</ul>
<p>待画框的图像。</p>
<ul class="simple">
<li><p>x0 : int</p></li>
</ul>
<p>矩形框在x轴上的起点。</p>
<ul class="simple">
<li><p>y0 : int</p></li>
</ul>
<p>矩形框在y轴上的起点。</p>
<ul class="simple">
<li><p>w : int</p></li>
</ul>
<p>矩形框的宽度。</p>
<ul class="simple">
<li><p>h : int</p></li>
</ul>
<p>矩形框的高度。</p>
<ul class="simple">
<li><p>color : tuple</p></li>
</ul>
<p>矩形框的颜色。</p>
<ul class="simple">
<li><p>thickness : int</p></li>
</ul>
<p>矩形框线条的粗细。</p>
<p><strong>返回值说明:</strong></p>
<p>如果画框成功返回0，否则返回非0值。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># ret = bmcv.rectangle(BMimg.data(), 20, 20, 600, 600,(0,0,255),2)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="fillrectangle">
<h2><span class="section-number">5.8.16. </span>fillRectangle<a class="headerlink" href="#fillrectangle" title="Link to this heading"></a></h2>
<p>在图像上填充一个矩形框。</p>
<p><strong>实现硬件</strong>
* BM1684: 智能视觉深度学习处理器
* BM1684X: VPP</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fillRectangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span>
        <span class="n">x0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">y0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fillRectangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">bm_image</span><span class="p">,</span>
        <span class="n">x0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">y0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>image : sail.BMImage 或 sail.bm_image</p></li>
</ul>
<p>待画框的图像。</p>
<ul class="simple">
<li><p>x0 : int</p></li>
</ul>
<p>矩形框在x轴上的起点。</p>
<ul class="simple">
<li><p>y0 : int</p></li>
</ul>
<p>矩形框在y轴上的起点。</p>
<ul class="simple">
<li><p>w : int</p></li>
</ul>
<p>矩形框的宽度。</p>
<ul class="simple">
<li><p>h : int</p></li>
</ul>
<p>矩形框的高度。</p>
<ul class="simple">
<li><p>color : tuple</p></li>
</ul>
<p>矩形框的颜色。</p>
<p><strong>返回值说明:</strong></p>
<p>如果画框成功返回0，否则返回非0值。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">fillRectangle</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span>
    <span class="c1"># ret = bmcv.fillRectangle(BMimg.data(), 20, 20, 600, 600,(0,0,255))</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="imwrite">
<h2><span class="section-number">5.8.17. </span>imwrite<a class="headerlink" href="#imwrite" title="Link to this heading"></a></h2>
<p>将图像保存在特定文件。</p>
<p><strong>实现硬件</strong></p>
<ul class="simple">
<li><p>BM1684: JPU+VPP+智能视觉深度学习处理器</p></li>
<li><p>BM1684X: JPU+VPP</p></li>
</ul>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">imwrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span>

<span class="k">def</span><span class="w"> </span><span class="nf">imwrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">bm_image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>file_name : str</p></li>
</ul>
<p>文件的名称。</p>
<ul class="simple">
<li><p>output : sail.BMImage 或 sail.bm_image</p></li>
</ul>
<p>需要保存的图像。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>process_status : int</p></li>
</ul>
<p>如果保存成功返回0，否则返回非0值。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.jpg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">BMimg</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span><span class="n">BMimg</span><span class="o">.</span><span class="n">height</span><span class="p">()),</span><span class="n">BMimg</span><span class="p">)</span>
    <span class="c1"># bmcv.imwrite(&quot;{}_{}.jpg&quot;.format(BMimg.width(),BMimg.height()),BMimg.data())</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="imread">
<h2><span class="section-number">5.8.18. </span>imread<a class="headerlink" href="#imread" title="Link to this heading"></a></h2>
<p>读取和解码图片文件，仅支持 JPEG baseline 格式的硬解码。对于其他格式，如 PNG 和 BMP，则采用软解码。
对于 JPEG baseline 图片，返回的 BMImage 将保持 YUV 色彩空间，像素格式依据图片文件本身的采样方式，例如 YUV420；
而对于其他格式，返回的 BMImage 将保持其输入的对应色彩空间。</p>
<p><strong>实现硬件</strong></p>
<ul class="simple">
<li><p>BM1684: JPU(JPEG baseline), CPU(其他格式)</p></li>
<li><p>BM1684X: JPU(JPEG baseline), CPU(其他格式)</p></li>
</ul>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">imread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BMImage</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>filename : str</p></li>
</ul>
<p>需要读取的图片文件路径。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage</p></li>
</ul>
<p>返回解码得到的BMImage。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="get-handle">
<h2><span class="section-number">5.8.19. </span>get_handle<a class="headerlink" href="#get-handle" title="Link to this heading"></a></h2>
<p>获取Bmcv中的设备句柄Handle。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sail</span><span class="o">.</span><span class="n">Handle</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>handle: sail.Handle</p></li>
</ul>
<p>Bmcv中的设备句柄Handle。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">handle1</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">get_handle</span><span class="p">()</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="crop-and-resize-padding">
<h2><span class="section-number">5.8.20. </span>crop_and_resize_padding<a class="headerlink" href="#crop-and-resize-padding" title="Link to this heading"></a></h2>
<p>对图像进行裁剪并resize，然后padding。</p>
<p><strong>实现硬件</strong>
* BM1684: VPP+智能视觉深度学习处理器
* BM1684X: VPP+智能视觉深度学习处理器</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">crop_and_resize_padding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span>
                <span class="n">crop_x0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">crop_y0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">crop_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">crop_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">resize_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">resize_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">padding</span><span class="p">:</span> <span class="n">PaddingAtrr</span><span class="p">,</span>
                <span class="n">resize_alg</span><span class="o">=</span><span class="n">sail</span><span class="o">.</span><span class="n">bmcv_resize_algorithm</span><span class="o">.</span><span class="n">BMCV_INTER_NEAREST</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage</p></li>
</ul>
<p>待处理的图像。</p>
<ul class="simple">
<li><p>crop_x0 : int</p></li>
</ul>
<p>裁剪窗口在x轴上的起始点。</p>
<ul class="simple">
<li><p>crop_y0 : int</p></li>
</ul>
<p>裁剪窗口在y轴上的起始点。</p>
<ul class="simple">
<li><p>crop_w : int</p></li>
</ul>
<p>裁剪窗口的宽。</p>
<ul class="simple">
<li><p>crop_h : int</p></li>
</ul>
<p>裁剪窗口的高。</p>
<ul class="simple">
<li><p>resize_w : int</p></li>
</ul>
<p>图像resize的目标宽度。</p>
<ul class="simple">
<li><p>resize_h : int</p></li>
</ul>
<p>图像resize的目标高度。</p>
<ul class="simple">
<li><p>padding : sail.PaddingAtrr</p></li>
</ul>
<p>padding的配置信息。</p>
<ul class="simple">
<li><p>resize_alg : bmcv_resize_algorithm</p></li>
</ul>
<p>resize采用的插值算法。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage</p></li>
</ul>
<p>返回处理后的图像。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">crop_x0</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">crop_y0</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">crop_w</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">crop_h</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">resize_w</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">resize_h</span> <span class="o">=</span> <span class="mi">300</span>

    <span class="n">paddingatt</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">PaddingAtrr</span><span class="p">()</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_stx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_sty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_w</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_h</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_r</span><span class="p">(</span><span class="mi">114</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_g</span><span class="p">(</span><span class="mi">114</span><span class="p">)</span>
    <span class="n">paddingatt</span><span class="o">.</span><span class="n">set_b</span><span class="p">(</span><span class="mi">114</span><span class="p">)</span>
    <span class="n">padded_BMimg</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">crop_and_resize_padding</span><span class="p">(</span>
        <span class="n">BMimg</span><span class="p">,</span>
        <span class="n">crop_x0</span><span class="p">,</span>
        <span class="n">crop_y0</span><span class="p">,</span>
        <span class="n">crop_w</span><span class="p">,</span>
        <span class="n">crop_h</span><span class="p">,</span>
        <span class="n">resize_w</span><span class="p">,</span>
        <span class="n">resize_h</span><span class="p">,</span>
        <span class="n">paddingatt</span><span class="p">,</span>
        <span class="n">sail</span><span class="o">.</span><span class="n">bmcv_resize_algorithm</span><span class="o">.</span><span class="n">BMCV_INTER_NEAREST</span>
    <span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="convert-format">
<h2><span class="section-number">5.8.21. </span>convert_format<a class="headerlink" href="#convert-format" title="Link to this heading"></a></h2>
<p>将图像的格式转换为output中的格式，并拷贝到output。</p>
<p><strong>实现硬件</strong>
* BM1684: VPP+智能视觉深度学习处理器
* BM1684X: VPP</p>
<dl>
<dt><strong>接口形式1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">convert_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明1:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage</p></li>
</ul>
<p>输入参数。待转换的图像。</p>
<ul class="simple">
<li><p>output : sail.BMImage</p></li>
</ul>
<p>输出参数。将input中的图像转化为output的图像格式并拷贝到output。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">convert_format</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>接口形式2:</strong></p>
<p>将一张图像转换成目标格式。</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">convert_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span> <span class="n">image_format</span><span class="p">:</span><span class="n">sail</span><span class="o">.</span><span class="n">bm_image_format_ext</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>参数说明2:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage</p></li>
</ul>
<p>待转换的图像。</p>
<ul class="simple">
<li><p>image_format : sail.bm_image_format_ext</p></li>
</ul>
<p>转换的目标格式。</p>
<p><strong>返回值说明2:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage</p></li>
</ul>
<p>返回转换后的图像。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">convert_format</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span><span class="n">sail</span><span class="o">.</span><span class="n">FORMAT_BGR_PLANAR</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="vpp-convert-format">
<h2><span class="section-number">5.8.22. </span>vpp_convert_format<a class="headerlink" href="#vpp-convert-format" title="Link to this heading"></a></h2>
<p>利用VPP硬件加速图片的格式转换。</p>
<p><strong>实现硬件</strong>
* BM1684: VPP
* BM1684X: VPP</p>
<dl>
<dt><strong>接口形式1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">vpp_convert_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明1:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage</p></li>
</ul>
<p>输入参数。待转换的图像。</p>
<ul class="simple">
<li><p>output : sail.BMImage</p></li>
</ul>
<p>输出参数。将input中的图像转化为output的图像格式并拷贝到output。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">vpp_convert_format</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>接口形式2:</strong></p>
<p>将一张图像转换成目标格式。</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">vpp_convert_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span> <span class="n">image_format</span><span class="p">:</span><span class="n">sail</span><span class="o">.</span><span class="n">bm_image_format_ext</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>参数说明2:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage</p></li>
</ul>
<p>待转换的图像。</p>
<ul class="simple">
<li><p>image_format : sail.bm_image_format_ext</p></li>
</ul>
<p>转换的目标格式。</p>
<p><strong>返回值说明2:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage</p></li>
</ul>
<p>返回转换后的图像。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">vpp_convert_format</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span><span class="n">sail</span><span class="o">.</span><span class="n">FORMAT_BGR_PLANAR</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="puttext">
<h2><span class="section-number">5.8.23. </span>putText<a class="headerlink" href="#puttext" title="Link to this heading"></a></h2>
<p>在图像上添加text。只支持英文文字。</p>
<p>输入的BMImage支持的像素格式为：
FORMAT_GRAY、FORMAT_YUV420P、FORMAT_YUV422P、FORMAT_YUV444P、FORMAT_NV12、
FORMAT_NV21、FORMAT_NV16、FORMAT_NV61。</p>
<p><strong>实现硬件</strong>
* BM1684: 处理器
* BM1684X: 处理器</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">putText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
        <span class="n">fontScale</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">thickness</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span>

<span class="k">def</span><span class="w"> </span><span class="nf">putText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">bm_image</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
        <span class="n">fontScale</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">thickness</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage 或 sail.bm_image</p></li>
</ul>
<p>待处理的图像。</p>
<ul class="simple">
<li><p>text: str</p></li>
</ul>
<p>需要添加的文本。</p>
<ul class="simple">
<li><p>x: int</p></li>
</ul>
<p>添加的起始点位置。</p>
<ul class="simple">
<li><p>y: int</p></li>
</ul>
<p>添加的起始点位置。</p>
<ul class="simple">
<li><p>color : tuple</p></li>
</ul>
<p>字体的颜色。</p>
<ul class="simple">
<li><p>fontScale: int</p></li>
</ul>
<p>字号的大小。</p>
<ul class="simple">
<li><p>thickness : int</p></li>
</ul>
<p>字体的粗细。建议设置为偶数。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>process_status : int</p></li>
</ul>
<p>如果处理成功返回0，否则返回非0值。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">bgr_img</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">yuv_img</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">convert_format</span><span class="p">(</span><span class="n">bgr_img</span><span class="p">,</span> <span class="n">sail</span><span class="o">.</span><span class="n">FORMAT_YUV420P</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">yuv_img</span><span class="p">,</span> <span class="s2">&quot;some text&quot;</span> <span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">],</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="image-add-weighted">
<h2><span class="section-number">5.8.24. </span>image_add_weighted<a class="headerlink" href="#image-add-weighted" title="Link to this heading"></a></h2>
<p>将两张图像按不同的权重相加。</p>
<p><strong>实现硬件</strong>
* BM1684: 智能视觉深度学习处理器
* BM1684X: 智能视觉深度学习处理器</p>
<dl>
<dt><strong>接口形式1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">image_add_weighted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">input0</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span>
            <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">input1</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span>
            <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">output</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明1:</strong></p>
<ul class="simple">
<li><p>input0 : sail.BMImage</p></li>
</ul>
<p>输入参数。待处理的图像0。</p>
<ul class="simple">
<li><p>alpha : float</p></li>
</ul>
<p>输入参数。两张图像相加的权重alpha</p>
<ul class="simple">
<li><p>input1 : sail.BMImage</p></li>
</ul>
<p>输入参数。待处理的图像1。</p>
<ul class="simple">
<li><p>beta : float</p></li>
</ul>
<p>输入参数。两张图像相加的权重beta</p>
<ul class="simple">
<li><p>gamma : float</p></li>
</ul>
<p>输入参数。两张图像相加的权重gamma</p>
<ul class="simple">
<li><p>output: BMImage</p></li>
</ul>
<p>输出参数。相加后的图像output = input1 * alpha + input2 * beta + gamma</p>
<dl>
<dt><strong>示例代码1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name1</span> <span class="o">=</span> <span class="s2">&quot;your_image_path1&quot;</span>
    <span class="n">image_name2</span> <span class="o">=</span> <span class="s2">&quot;your_image_path2&quot;</span>
    <span class="n">decoder1</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name1</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">decoder2</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name2</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg1</span> <span class="o">=</span> <span class="n">decoder1</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">BMimg2</span> <span class="o">=</span> <span class="n">decoder2</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">bmg</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">image_add_weighted</span><span class="p">(</span><span class="n">BMimg1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="n">BMimg2</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="n">bmg</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt><strong>接口形式2:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">image_add_weighted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">input0</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span>
            <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">input1</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span>
            <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明2:</strong></p>
<ul class="simple">
<li><p>input0 : sail.BMImage</p></li>
</ul>
<p>输入参数。待处理的图像0。</p>
<ul class="simple">
<li><p>alpha : float</p></li>
</ul>
<p>输入参数。两张图像相加的权重alpha</p>
<ul class="simple">
<li><p>input1 : sail.BMImage</p></li>
</ul>
<p>输入参数。待处理的图像1。</p>
<ul class="simple">
<li><p>beta : float</p></li>
</ul>
<p>输入参数。两张图像相加的权重beta</p>
<ul class="simple">
<li><p>gamma : float</p></li>
</ul>
<p>输入参数。两张图像相加的权重gamma</p>
<p><strong>返回值说明2:</strong></p>
<ul class="simple">
<li><p>output: sail.BMImage</p></li>
</ul>
<p>返回相加后的图像output = input1 * alpha + input2 * beta + gamma</p>
<dl>
<dt><strong>示例代码2:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name1</span> <span class="o">=</span> <span class="s2">&quot;your_image_path1&quot;</span>
    <span class="n">image_name2</span> <span class="o">=</span> <span class="s2">&quot;your_image_path2&quot;</span>
    <span class="n">decoder1</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name1</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">decoder2</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name2</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg1</span> <span class="o">=</span> <span class="n">decoder1</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">BMimg2</span> <span class="o">=</span> <span class="n">decoder2</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">bmg</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">image_add_weighted</span><span class="p">(</span><span class="n">BMimg1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="n">BMimg2</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="image-copy-to">
<h2><span class="section-number">5.8.25. </span>image_copy_to<a class="headerlink" href="#image-copy-to" title="Link to this heading"></a></h2>
<p>进行图像间的数据拷贝</p>
<p><strong>实现硬件</strong>
* BM1684: 智能视觉深度学习处理器
* BM1684X: VPP+智能视觉深度学习处理器</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">image_copy_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="nb">input</span><span class="p">:</span> <span class="n">BMImage</span><span class="o">|</span><span class="n">BMImageArray</span><span class="p">,</span>
            <span class="n">output</span><span class="p">:</span> <span class="n">BMImage</span><span class="o">|</span><span class="n">BMImageArray</span><span class="p">,</span>
            <span class="n">start_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">start_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input: BMImage|BMImageArray</p></li>
</ul>
<p>输入参数。待拷贝的BMImage或BMImageArray。</p>
<ul class="simple">
<li><p>output: BMImage|BMImageArray</p></li>
</ul>
<p>输出参数。拷贝后的BMImage或BMImageArray</p>
<ul class="simple">
<li><p>start_x: int</p></li>
</ul>
<p>输入参数。拷贝到目标图像的起始点。</p>
<ul class="simple">
<li><p>start_y: int</p></li>
</ul>
<p>输入参数。拷贝到目标图像的起始点。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name1</span> <span class="o">=</span> <span class="s2">&quot;your_image_path1&quot;</span>
    <span class="n">image_name2</span> <span class="o">=</span> <span class="s2">&quot;your_image_path2&quot;</span>
    <span class="n">decoder1</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name1</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">decoder2</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name2</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg1</span> <span class="o">=</span> <span class="n">decoder1</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">BMimg2</span> <span class="o">=</span> <span class="n">decoder2</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">image_copy_to</span><span class="p">(</span><span class="n">BMimg1</span><span class="p">,</span><span class="n">BMimg2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="image-copy-to-padding">
<h2><span class="section-number">5.8.26. </span>image_copy_to_padding<a class="headerlink" href="#image-copy-to-padding" title="Link to this heading"></a></h2>
<p>进行input和output间的图像数据拷贝并padding。</p>
<p><strong>实现硬件</strong>
* BM1684: 智能视觉深度学习处理器
* BM1684X: VPP+智能视觉深度学习处理器</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">image_copy_to_padding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="nb">input</span><span class="p">:</span> <span class="n">BMImage</span><span class="o">|</span><span class="n">BMImageArray</span><span class="p">,</span>
            <span class="n">output</span><span class="p">:</span> <span class="n">BMImage</span><span class="o">|</span><span class="n">BMImageArray</span><span class="p">,</span>
            <span class="n">padding_r</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">padding_g</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">padding_b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">start_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">start_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input: BMImage|BMImageArray</p></li>
</ul>
<p>输入参数。待拷贝的BMImage或BMImageArray。</p>
<ul class="simple">
<li><p>output: BMImage|BMImageArray</p></li>
</ul>
<p>输出参数。拷贝后的BMImage或BMImageArray</p>
<ul class="simple">
<li><p>padding_r: int</p></li>
</ul>
<p>输入参数。R通道的padding值。</p>
<ul class="simple">
<li><p>padding_g: int</p></li>
</ul>
<p>输入参数。G通道的padding值。</p>
<ul class="simple">
<li><p>padding_b: int</p></li>
</ul>
<p>输入参数。B通道的padding值。</p>
<ul class="simple">
<li><p>start_x: int</p></li>
</ul>
<p>输入参数。拷贝到目标图像的起始点。</p>
<ul class="simple">
<li><p>start_y: int</p></li>
</ul>
<p>输入参数。拷贝到目标图像的起始点。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name1</span> <span class="o">=</span> <span class="s2">&quot;your_image_path1&quot;</span>
    <span class="n">image_name2</span> <span class="o">=</span> <span class="s2">&quot;your_image_path2&quot;</span>
    <span class="n">decoder1</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name1</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">decoder2</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name2</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg1</span> <span class="o">=</span> <span class="n">decoder1</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">BMimg2</span> <span class="o">=</span> <span class="n">decoder2</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">image_copy_to_padding</span><span class="p">(</span><span class="n">BMimg1</span><span class="p">,</span><span class="n">BMimg2</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="nms">
<h2><span class="section-number">5.8.27. </span>nms<a class="headerlink" href="#nms" title="Link to this heading"></a></h2>
<p>利用智能视觉深度学习处理器进行NMS</p>
<p><strong>注意：请查询《BMCV开发参考手册/BMCV API》确认当前算子是否适配BM1688。</strong></p>
<p><strong>实现硬件</strong>
* BM1684: 智能视觉深度学习处理器
* BM1684X: 智能视觉深度学习处理器</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">nms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input: numpy.ndarray</p></li>
</ul>
<p>待处理的检测框的数组，shape必须是（n,5） n&lt;56000 [left,top,right,bottom,score]。</p>
<ul class="simple">
<li><p>threshold: float</p></li>
</ul>
<p>nms的阈值。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>result: numpy.ndarray</p></li>
</ul>
<p>返回NMS后的检测框数组。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">input_boxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">130</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">205</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]</span>
    <span class="p">])</span>
    <span class="n">nms_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">selected_boxes</span>  <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">nms</span><span class="p">(</span><span class="n">input_boxes</span><span class="p">,</span> <span class="n">nms_threshold</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">selected_boxes</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="drawpoint">
<h2><span class="section-number">5.8.28. </span>drawPoint<a class="headerlink" href="#drawpoint" title="Link to this heading"></a></h2>
<p>在图像上画点。</p>
<p><strong>实现硬件</strong>
* BM1684: 处理器
* BM1684X: VPP</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">drawPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">BMImage</span><span class="p">,</span>
        <span class="n">center</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">color</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>

<span class="k">def</span><span class="w"> </span><span class="nf">drawPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">bm_image</span><span class="p">,</span>
        <span class="n">center</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">color</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>image: BMImage 或 bm_image</p></li>
</ul>
<p>输入图像，在该BMImage上直接画点作为输出。</p>
<ul class="simple">
<li><p>center: Tuple[int, int]</p></li>
</ul>
<p>点的中心坐标。</p>
<ul class="simple">
<li><p>color: Tuple[int, int, int]</p></li>
</ul>
<p>点的颜色。</p>
<ul class="simple">
<li><p>radius: int</p></li>
</ul>
<p>点的半径。</p>
<p><strong>返回值说明</strong></p>
<p>如果画点成功返回0，否则返回非0值。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">drawPoint</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span> <span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="mi">320</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># ret = bmcv.drawPoint(BMimg.data(), (320, 320), (0,255,255),2)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="warp-perspective">
<h2><span class="section-number">5.8.29. </span>warp_perspective<a class="headerlink" href="#warp-perspective" title="Link to this heading"></a></h2>
<p>对图像进行透视变换。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">warp_perspective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="nb">input</span><span class="p">:</span> <span class="n">BMImage</span><span class="p">,</span>
            <span class="n">coordinate</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
            <span class="n">output_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">output_height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="nb">format</span><span class="p">:</span> <span class="n">bm_image_format_ext</span> <span class="o">=</span> <span class="n">FORMAT_BGR_PLANAR</span><span class="p">,</span>
            <span class="n">dtype</span><span class="p">:</span> <span class="n">bm_image_data_format_ext</span> <span class="o">=</span> <span class="n">DATA_TYPE_EXT_1N_BYTE</span><span class="p">,</span>
            <span class="n">use_bilinear</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BMImage</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input: BMImage</p></li>
</ul>
<p>待处理的图像。</p>
<ul class="simple">
<li><p>coordinate: tuple</p></li>
</ul>
<p>变换区域的四顶点原始坐标。tuple(tuple(int,int))</p>
<p>例如((left_top.x, left_top.y), (right_top.x, right_top.y),
(left_bottom.x, left_bottom.y), (right_bottom.x, right_bottom.y))</p>
<ul class="simple">
<li><p>output_width: Output width</p></li>
</ul>
<p>输出图像的宽。</p>
<ul class="simple">
<li><p>output_height: Output height</p></li>
</ul>
<p>输出图像的高。</p>
<ul class="simple">
<li><p>bm_image_format_ext: sail.Format</p></li>
</ul>
<p>输出图像的格式。</p>
<ul class="simple">
<li><p>dtype: sail.ImgDtype</p></li>
</ul>
<p>输出图像的数据类型。</p>
<ul class="simple">
<li><p>use_bilinear: bool</p></li>
</ul>
<p>是否使用双线性插值。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>output: image</p></li>
</ul>
<p>输出变换后的图像。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">warp_perspective</span><span class="p">(</span><span class="n">BMimg</span><span class="p">,</span> <span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">540</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">380</span><span class="p">),</span> <span class="p">(</span><span class="mi">540</span><span class="p">,</span> <span class="mi">380</span><span class="p">)),</span><span class="mi">640</span><span class="p">,</span><span class="mi">640</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="get-bm-data-type">
<h2><span class="section-number">5.8.30. </span>get_bm_data_type<a class="headerlink" href="#get-bm-data-type" title="Link to this heading"></a></h2>
<p>将ImgDtype转换为Dtype</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_bm_data_type</span><span class="p">((</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">ImgDtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sail</span><span class="o">.</span><span class="n">Dtype</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>format: sail.ImgDtype</p></li>
</ul>
<p>需要转换的类型。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>ret: sail.Dtype</p></li>
</ul>
<p>转换后的类型。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">get_bm_data_type</span><span class="p">(</span><span class="n">sail</span><span class="o">.</span><span class="n">DATA_TYPE_EXT_FLOAT32</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="get-bm-image-data-format">
<h2><span class="section-number">5.8.31. </span>get_bm_image_data_format<a class="headerlink" href="#get-bm-image-data-format" title="Link to this heading"></a></h2>
<p>将Dtype转换为ImgDtype。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_bm_image_data_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">Dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sail</span><span class="o">.</span><span class="n">ImgDtype</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>dtype: sail.Dtype</p></li>
</ul>
<p>需要转换的sail.Dtype</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>ret: sail.ImgDtype</p></li>
</ul>
<p>返回转换后的类型。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">get_bm_image_data_format</span><span class="p">(</span><span class="n">sail</span><span class="o">.</span><span class="n">BM_FLOAT32</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="imdecode">
<h2><span class="section-number">5.8.32. </span>imdecode<a class="headerlink" href="#imdecode" title="Link to this heading"></a></h2>
<p>从内存中载入图像到BMImage中。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">imdecode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>data_bytes: bytes</p></li>
</ul>
<p>系统内存中图像的bytes</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>ret: sail.BMImage</p></li>
</ul>
<p>返回解码后的图像。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image_file</span><span class="p">:</span>
        <span class="n">image_data_bytes</span> <span class="o">=</span> <span class="n">image_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">src_img</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">imdecode</span><span class="p">(</span><span class="n">image_data_bytes</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="imencode">
<h2><span class="section-number">5.8.33. </span>imencode<a class="headerlink" href="#imencode" title="Link to this heading"></a></h2>
<p>编码一张图片，并返回编码后的数据。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">imencode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">img</span><span class="p">:</span> <span class="n">BMImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>ext: str</p></li>
</ul>
<p>输入参数。图片编码格式。 <code class="docutils literal notranslate"><span class="pre">&quot;.jpg&quot;</span></code> , <code class="docutils literal notranslate"><span class="pre">&quot;.png&quot;</span></code> 等。</p>
<ul class="simple">
<li><p>img: BMImage</p></li>
</ul>
<p>输入参数。输入图片，只支持FORMAT_BGR_PACKED，DATA_TYPE_EXT_1N_BYTE的图片。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>ret: numpy.array</p></li>
</ul>
<p>编码后放在系统内存中的数据。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">imencode</span><span class="p">(</span><span class="s2">&quot;.jpg&quot;</span><span class="p">,</span><span class="n">BMimg</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="fft">
<h2><span class="section-number">5.8.34. </span>fft<a class="headerlink" href="#fft" title="Link to this heading"></a></h2>
<p>实现对Tensor的快速傅里叶变换。</p>
<p><strong>注意：请查询《BMCV开发参考手册/BMCV API》确认当前算子是否适配BM1688。</strong></p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">input_real</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span>

<span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">input_real</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">input_imag</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>forward: bool</p></li>
</ul>
<p>是否进行正向迁移。</p>
<ul class="simple">
<li><p>input_real: Tensor</p></li>
</ul>
<p>输入的实数部分。</p>
<ul class="simple">
<li><p>input_imag: Tensor</p></li>
</ul>
<p>输入的虚数部分。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>ret: list[Tensor]</p></li>
</ul>
<p>返回输出的实数部分和虚数部分。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">random_array1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
    <span class="n">random_array2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">input_real</span>  <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="n">random_array1</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">input_imag</span>  <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="n">random_array2</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">forward</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">result_complex</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span><span class="n">input_real</span><span class="p">,</span><span class="n">input_imag</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="convert-yuv420p-to-gray">
<h2><span class="section-number">5.8.35. </span>convert_yuv420p_to_gray<a class="headerlink" href="#convert-yuv420p-to-gray" title="Link to this heading"></a></h2>
<p>将YUV420P格式的图片转为灰度图。</p>
<dl>
<dt><strong>接口形式1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">convert_yuv420p_to_gray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明1:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage</p></li>
</ul>
<p>输入参数。待转换的图像。</p>
<ul class="simple">
<li><p>output : sail.BMImage</p></li>
</ul>
<p>输出参数。转换后的图像。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg1</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">BMimg2</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">convert_yuv420p_to_gray</span><span class="p">(</span><span class="n">BMimg1</span><span class="p">,</span><span class="n">BMimg2</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>接口形式2:</strong></p>
<p>将YUV420P格式的图片转为灰度图。</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">convert_yuv420p_to_gray_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">bm_image</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">bm_image</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>参数说明2:</strong></p>
<ul class="simple">
<li><p>input : sail.bm_image</p></li>
</ul>
<p>待转换的图像。</p>
<ul class="simple">
<li><p>output : sail.bm_image</p></li>
</ul>
<p>转换后的图像。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg1</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">bmg</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">convert_yuv420p_to_gray_</span><span class="p">(</span><span class="n">BMimg1</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span><span class="n">bmg</span><span class="o">.</span><span class="n">data</span><span class="p">())</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="mat-to-bm-image">
<h2><span class="section-number">5.8.36. </span>mat_to_bm_image<a class="headerlink" href="#mat-to-bm-image" title="Link to this heading"></a></h2>
<p>将opencv的mat转为sail的BMImage。</p>
<dl>
<dt><strong>接口形式1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">mat_to_bm_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">BMImage</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明1:</strong></p>
<ul class="simple">
<li><p>mat : numpy</p></li>
</ul>
<p>输入参数。待转换的opencv mat。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>ret: sail.BMImage</p></li>
</ul>
<p>返回转换后的sail.BMImage。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">opencv_mat</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_name</span><span class="p">)</span>
    <span class="n">sail_bm_image</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">mat_to_bm_image</span><span class="p">(</span><span class="n">opencv_mat</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt><strong>接口形式2:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">mat_to_bm_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span> <span class="n">img</span><span class="p">:</span> <span class="n">BMImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明2:</strong></p>
<ul class="simple">
<li><p>mat : numpy</p></li>
</ul>
<p>待转换的opencv mat。</p>
<ul class="simple">
<li><p>img : sail.BMImage</p></li>
</ul>
<p>转换后的BMImage。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>ret: int</p></li>
</ul>
<p>成功后返回0</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">opencv_mat</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_name</span><span class="p">)</span>
    <span class="n">BMimg2</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">mat_to_bm_image</span><span class="p">(</span><span class="n">opencv_mat</span><span class="p">,</span><span class="n">BMimg2</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="watermark-superpose">
<h2><span class="section-number">5.8.37. </span>watermark_superpose<a class="headerlink" href="#watermark-superpose" title="Link to this heading"></a></h2>
<p>实现对图片添加多个水印。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">watermark_superpose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<span class="n">image</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span>
<span class="n">water_name</span><span class="p">:</span><span class="n">string</span><span class="p">,</span>
<span class="n">bitmap_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="n">pitch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="n">rects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
<span class="n">color</span><span class="p">:</span> <span class="nb">tuple</span>
        <span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>image: sail.BMImage</p></li>
</ul>
<p>输入图片</p>
<ul class="simple">
<li><p>water_name:string</p></li>
</ul>
<p>水印文件路径</p>
<ul class="simple">
<li><p>bitmap_type: int</p></li>
</ul>
<p>输入参数。水印类型, 值0表示水印为8bit数据类型(有透明度信息), 值1表示水印为1bit数据类型(无透明度信息)。</p>
<ul class="simple">
<li><p>pitch: int</p></li>
</ul>
<p>输入参数。水印文件每行的byte数, 可理解为水印的宽。</p>
<ul class="simple">
<li><p>rects: list[list[int]]</p></li>
</ul>
<p>输入参数。水印位置，包含每个水印起始点和宽高。</p>
<ul class="simple">
<li><p>color: tuple</p></li>
</ul>
<p>输入参数。水印的颜色。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>ret: int</p></li>
</ul>
<p>返回是否成功</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path1&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg1</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">water_name</span> <span class="o">=</span> <span class="s1">&#39;your_watermark_path&#39;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">watermark_superpose</span><span class="p">(</span><span class="n">BMimg1</span><span class="p">,</span><span class="n">water_name</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">117</span><span class="p">,[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">117</span><span class="p">,</span><span class="mi">79</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">117</span><span class="p">,</span><span class="mi">79</span><span class="p">]],[</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">])</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="polylines">
<h2><span class="section-number">5.8.38. </span>polylines<a class="headerlink" href="#polylines" title="Link to this heading"></a></h2>
<p>可以实现在一张图像上画一条或多条线段，从而可以实现画多边形的功能，并支持指定线的颜色和线的宽度。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">def</span><span class="w"> </span><span class="n">polylines</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="o">:</span><span class="w"> </span><span class="n">BMImage</span><span class="p">,</span><span class="w"> </span><span class="n">pts</span><span class="o">:</span><span class="w"> </span><span class="n">list</span><span class="p">[</span><span class="n">list</span><span class="p">[</span><span class="n">tuple</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">)]],</span><span class="w"> </span><span class="n">isClosed</span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">:</span><span class="w"> </span><span class="n">tuple</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">thickness</span><span class="o">:</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">shift</span><span class="o">:</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">int</span><span class="o">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>img : sail.BMImage</p></li>
</ul>
<p>输入图片。</p>
<ul class="simple">
<li><p>pts : list[list[tuple(int, int)]]</p></li>
</ul>
<p>线段的起始点和终点坐标，可输入多个坐标点。图像左上角为原点，向右延伸为x方向，向下延伸为y方向。</p>
<ul class="simple">
<li><p>isClosed : bool</p></li>
</ul>
<p>图形是否闭合。</p>
<ul class="simple">
<li><p>color : tuple(int, int, int)</p></li>
</ul>
<p>画线的颜色，分别为RGB三个通道的值。</p>
<ul class="simple">
<li><p>thickness : int</p></li>
</ul>
<p>画线的宽度，对于YUV格式的图像建议设置为偶数。</p>
<ul class="simple">
<li><p>shift : int</p></li>
</ul>
<p>多边形缩放倍数，默认不缩放。缩放倍数为(1/2)^shift。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>ret: int</p></li>
</ul>
<p>成功后返回0</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg1</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">bm</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">vpp_convert_format</span><span class="p">(</span><span class="n">BMimg1</span><span class="p">,</span><span class="n">sail</span><span class="o">.</span><span class="n">FORMAT_YUV444P</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">polylines</span><span class="p">(</span><span class="n">bm</span><span class="p">,[[(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">),(</span><span class="mi">40</span><span class="p">,</span><span class="mi">80</span><span class="p">)]],</span><span class="kc">True</span><span class="p">,[</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">])</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="mosaic">
<h2><span class="section-number">5.8.39. </span>mosaic<a class="headerlink" href="#mosaic" title="Link to this heading"></a></h2>
<p>该接口用于在图像上打一个或多个马赛克。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">mosaic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mosaic_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">img</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span> <span class="n">rects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]],</span> <span class="n">is_expand</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>mosaic_num : int</p></li>
</ul>
<p>马赛克数量，指rects中列表长度。</p>
<ul class="simple">
<li><p>img : sail.BMImage</p></li>
</ul>
<p>待转换的图像。</p>
<ul class="simple">
<li><p>rects : list[list[int,int,int,int]]</p></li>
</ul>
<p>多个马赛克位置，列表中每个元素中参数为[马赛克在x轴起始点,马赛克在y轴起始点,马赛克宽,马赛克高]</p>
<ul class="simple">
<li><p>is_expand : int</p></li>
</ul>
<p>是否扩列。值为0时表示不扩列, 值为1时表示在原马赛克周围扩列一个宏块(8个像素)。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>ret: int</p></li>
</ul>
<p>成功后返回0</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg1</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">mosaic</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">BMimg1</span><span class="p">,</span> <span class="p">[[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">2000</span><span class="p">],[</span><span class="mi">500</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">100</span><span class="p">]],</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="gaussian-blur">
<h2><span class="section-number">5.8.40. </span>gaussian_blur<a class="headerlink" href="#gaussian-blur" title="Link to this heading"></a></h2>
<p>该接口用于对图像进行高斯滤波。
<strong>注意：旧版本SDK并不支持BM1684X，当前SDK是否支持请查询《BMCV开发参考手册》, BMCV API页面查看。</strong></p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">gaussian_blur</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">BMImage</span><span class="p">,</span> <span class="n">kw</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">kh</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sigmaX</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigmaY</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BMImage</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage</p></li>
</ul>
<p>待转换的图像。</p>
<ul class="simple">
<li><p>kw : int</p></li>
</ul>
<p>kernel 在width方向上的大小。</p>
<ul class="simple">
<li><p>kh : int</p></li>
</ul>
<p>kernel 在height方向上的大小。</p>
<ul class="simple">
<li><p>sigmaX : float</p></li>
</ul>
<p>X方向上的高斯核标准差。</p>
<ul class="simple">
<li><p>sigmaY : float</p></li>
</ul>
<p>Y方向上的高斯核标准差。如果为0则表示与X方向上的高斯核标准差相同。默认为0。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>output : sail.BMImage</p></li>
</ul>
<p>返回经过高斯滤波的图像。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>


    <span class="n">bmimg</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="s2">&quot;your_img.jpg&quot;</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bmimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">bmimg</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">gaussian_blur</span><span class="p">(</span><span class="n">bmimg</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

    <span class="n">bmcv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&quot;out.jpg&quot;</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="transpose">
<h2><span class="section-number">5.8.41. </span>transpose<a class="headerlink" href="#transpose" title="Link to this heading"></a></h2>
<p>该接口可以实现图片宽和高的转置。</p>
<dl>
<dt><strong>接口形式1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明1:</strong></p>
<ul class="simple">
<li><p>src : sail.BMImage</p></li>
</ul>
<p>待转换的图像。</p>
<p><strong>返回值说明1:</strong></p>
<ul class="simple">
<li><p>output: sail.BMImage:</p></li>
</ul>
<p>返回转换后的图像。</p>
<dl>
<dt><strong>接口形式2:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明2:</strong></p>
<ul class="simple">
<li><p>src : sail.BMImage</p></li>
</ul>
<p>待转换的图像。</p>
<ul class="simple">
<li><p>dst : sail.BMImage</p></li>
</ul>
<p>输出图像的 sail.BMImage 结构体。</p>
<p><strong>返回值说明2:</strong></p>
<ul class="simple">
<li><p>ret : int</p></li>
</ul>
<p>成功返回0，否则返回非0值。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">bmimg</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="s2">&quot;your_img.jpg&quot;</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bmimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">convert_format</span><span class="p">(</span><span class="n">bmimg</span><span class="p">,</span><span class="n">sail</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">FORMAT_GRAY</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;readed&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="n">bmcv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&quot;out.jpg&quot;</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="sobel">
<h2><span class="section-number">5.8.42. </span>Sobel<a class="headerlink" href="#sobel" title="Link to this heading"></a></h2>
<p>边缘检测Sobel算子。</p>
<p><strong>注意：请查询《BMCV开发参考手册/BMCV API》确认当前算子是否适配BM1684X、BM1688。</strong></p>
<dl>
<dt><strong>接口形式1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">Sobel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">BMImage</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">BMImage</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ksize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明1:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage</p></li>
</ul>
<p>待转换的图像。</p>
<ul class="simple">
<li><p>output : sail.BMImage</p></li>
</ul>
<p>转换后的图像。</p>
<ul class="simple">
<li><p>dx : int</p></li>
</ul>
<p>x方向上的差分阶数。</p>
<ul class="simple">
<li><p>dy : int</p></li>
</ul>
<p>y方向上的差分阶数。</p>
<ul class="simple">
<li><p>ksize : int</p></li>
</ul>
<p>Sobel核的大小，必须是-1,1,3,5或7。其中特殊的，如果是-1则使用3×3 Scharr滤波器，如果是1则使用3×1或者1×3的核。默认值为3。</p>
<ul class="simple">
<li><p>scale : float</p></li>
</ul>
<p>对求出的差分结果乘以该系数，默认值为1。</p>
<ul class="simple">
<li><p>delta : float</p></li>
</ul>
<p>在输出最终结果之前加上该偏移量，默认值为0。</p>
<p><strong>返回值说明1:</strong></p>
<ul class="simple">
<li><p>ret: int</p></li>
</ul>
<p>成功后返回0</p>
<dl>
<dt><strong>接口形式2:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">Sobel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">BMImage</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ksize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BMImage</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明2:</strong></p>
<ul class="simple">
<li><p>input : sail.BMImage</p></li>
</ul>
<p>待转换的图像。</p>
<ul class="simple">
<li><p>dx : int</p></li>
</ul>
<p>x方向上的差分阶数。</p>
<ul class="simple">
<li><p>dy : int</p></li>
</ul>
<p>y方向上的差分阶数。</p>
<ul class="simple">
<li><p>ksize : int</p></li>
</ul>
<p>Sobel核的大小，必须是-1,1,3,5或7。其中特殊的，如果是-1则使用3×3 Scharr滤波器，如果是1则使用3×1或者1×3的核。默认值为3。</p>
<ul class="simple">
<li><p>scale : float</p></li>
</ul>
<p>对求出的差分结果乘以该系数，默认值为1。</p>
<ul class="simple">
<li><p>delta : float</p></li>
</ul>
<p>在输出最终结果之前加上该偏移量，默认值为0。</p>
<p><strong>返回值说明2:</strong></p>
<ul class="simple">
<li><p>output: sail.BMImage</p></li>
</ul>
<p>返回转换后的图像。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">bmimg</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">()</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="s2">&quot;your_img.jpg&quot;</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">bmimg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">bmimg</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">bmimg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">bmcv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&quot;out.jpg&quot;</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="drawlines">
<h2><span class="section-number">5.8.43. </span>drawLines<a class="headerlink" href="#drawlines" title="Link to this heading"></a></h2>
<p>在给定的图像上绘制多条线段。</p>
<p><strong>注意：请查询《BMCV开发参考手册/BMCV API》确认当前算子是否适配BM1684X。</strong></p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">drawLines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">BMImage</span><span class="p">,</span> <span class="n">start_points</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">end_points</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">line_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">thickness</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>img : sail.BMImage</p></li>
</ul>
<p>输入图片。</p>
<ul class="simple">
<li><p>start_points : list[tuple[int, int]]</p></li>
</ul>
<p>线段的起始点坐标列表，图像左上角为原点，向右为x方向，向下为y方向。</p>
<ul class="simple">
<li><p>end_points : list[tuple[int, int]]</p></li>
</ul>
<p>线段的结束点坐标列表，必须与起始点列表长度相同。</p>
<ul class="simple">
<li><p>line_num : int</p></li>
</ul>
<p>线段的数量，必须和线段起、终点列表长度值相同</p>
<ul class="simple">
<li><p>color : tuple[int, int, int]</p></li>
</ul>
<p>线段的颜色，RGB格式。</p>
<ul class="simple">
<li><p>thickness : int</p></li>
</ul>
<p>线段的宽度。</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>ret: int</p></li>
</ul>
<p>成功后返回0。</p>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;your_image_path&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">BMimg1</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="c1"># here is a sail.BMImage</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">start_points</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">)]</span>
    <span class="n">end_points</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">)]</span>
    <span class="n">line_num</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">thickness</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">bm</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">vpp_convert_format</span><span class="p">(</span><span class="n">BMimg1</span><span class="p">,</span><span class="n">sail</span><span class="o">.</span><span class="n">FORMAT_YUV444P</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">drawLines</span><span class="p">(</span><span class="n">bm</span><span class="p">,</span> <span class="n">start_points</span><span class="p">,</span> <span class="n">end_points</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span><span class="n">color</span><span class="p">,</span> <span class="n">thickness</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="stft">
<h2><span class="section-number">5.8.44. </span>stft<a class="headerlink" href="#stft" title="Link to this heading"></a></h2>
<p>实现对信号的短时傅里叶变换（STFT）。</p>
<p><strong>注意：请查询《BMCV开发参考手册/BMCV API》确认当前算子是否适配BM1684X。</strong></p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_real</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">input_imag</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">real_input</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">n_fft</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hop_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">pad_mode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">win_mode</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>

<span class="n">stft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_real</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">input_imag</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">real_input</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">n_fft</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hop_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">pad_mode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">win_mode</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>input_real: numpy.ndarray 或者 Tensor</dt><dd><p>输入信号的实数部分。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>input_imag: numpy.ndarray 或者 Tensor</dt><dd><p>输入信号的虚数部分。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>real_input: bool</dt><dd><p>是否仅使用实数输入的标志。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>normalize: bool</dt><dd><p>是否对输出进行归一化的标志。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>n_fft: int</dt><dd><p>STFT计算中使用的FFT点数。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>hop_len: int</dt><dd><p>窗口滑动的步长。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>pad_mode: int</dt><dd><p>输入信号的填充模式，0表示CONSTANT填充，1表示REFLECT填充。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>win_mode: int</dt><dd><p>窗口函数的类型，0表示HANN窗，1表示HAMM窗。</p>
</dd>
</dl>
</li>
</ul>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>result: tuple[numpy.ndarray, numpy.ndarray] 或者 tuple[Tensor, Tensor]</dt><dd><p>返回输出的实数部分和虚数部分。</p>
</dd>
</dl>
</li>
</ul>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">random_array1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">random_array2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">input_real</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">random_array1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">input_imag</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">random_array2</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">real_input</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">n_fft</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="n">hop_len</span> <span class="o">=</span> <span class="mi">256</span>
    <span class="n">pad_mode</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 填充模式示例</span>
    <span class="n">win_mode</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 窗口类型示例</span>
    <span class="n">stft_R</span><span class="p">,</span> <span class="n">stft_I</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">stft</span><span class="p">(</span><span class="n">input_real</span><span class="p">,</span> <span class="n">input_imag</span><span class="p">,</span> <span class="n">real_input</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">n_fft</span><span class="p">,</span> <span class="n">hop_len</span><span class="p">,</span> <span class="n">pad_mode</span><span class="p">,</span> <span class="n">win_mode</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="istft">
<h2><span class="section-number">5.8.45. </span>istft<a class="headerlink" href="#istft" title="Link to this heading"></a></h2>
<p>实现对信号的逆短时傅里叶变换（ISTFT）。</p>
<p><strong>注意：请查询《BMCV开发参考手册/BMCV API》确认当前算子是否适配BM1684X。</strong></p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">istft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_real</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">input_imag</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">real_input</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">L</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hop_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">pad_mode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">win_mode</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>

<span class="n">istft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_real</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">input_imag</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">real_input</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">L</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hop_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">pad_mode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">win_mode</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>input_real: numpy.ndarray 或者 Tensor</dt><dd><p>输入信号的实数部分。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>input_imag: numpy.ndarray 或者 Tensor</dt><dd><p>输入信号的虚数部分。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>real_input: bool</dt><dd><p>输出的信号是否为实数， false 为复数， true 为实数。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>normalize: bool</dt><dd><p>是否对输出进行归一化。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>L: int</dt><dd><p>原始时域信号的长度。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>hop_len: int</dt><dd><p>窗口滑动的步长，必须与STFT计算时使用的值相同。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>pad_mode: int</dt><dd><p>输入信号的填充模式，必须与STFT计算时使用的值相同。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>win_mode: int</dt><dd><p>窗口函数的类型，必须与STFT计算时使用的值相同。</p>
</dd>
</dl>
</li>
</ul>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>result: tuple[numpy.ndarray, numpy.ndarray] 或者 tuple[Tensor, Tensor]</dt><dd><p>返回输出的实数部分和虚数部分。</p>
</dd>
</dl>
</li>
</ul>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">random_array1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">513</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">random_array2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">513</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">input_real</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">random_array1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">input_imag</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">random_array2</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">real_input</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mi">4096</span>
    <span class="n">hop_len</span> <span class="o">=</span> <span class="mi">256</span>
    <span class="n">pad_mode</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 填充模式示例</span>
    <span class="n">win_mode</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 窗口类型示例</span>
    <span class="n">istft_R</span><span class="p">,</span> <span class="n">istft_I</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">istft</span><span class="p">(</span><span class="n">input_real</span><span class="p">,</span> <span class="n">input_imag</span><span class="p">,</span> <span class="n">real_input</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">hop_len</span><span class="p">,</span> <span class="n">pad_mode</span><span class="p">,</span> <span class="n">win_mode</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="bmcv-overlay">
<h2><span class="section-number">5.8.46. </span>bmcv_overlay<a class="headerlink" href="#bmcv-overlay" title="Link to this heading"></a></h2>
<p>图片上添加带透明通道的水印图。仅支持BM1688和CV186AH。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">bmcv_overlay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">BMImage</span><span class="p">,</span> <span class="n">overlay_info</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">overlay_image</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BMImage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><p>image : sail.BMImage</p></li>
</ul>
<p>输入/输出图片。</p>
<ul class="simple">
<li><p>overlay_info: list[list[int]]</p></li>
</ul>
<p>一组水印图的位置大小信息，格式是[x,y,w,h]</p>
<ul class="simple">
<li><p>overlay_image: list[BMImage]</p></li>
</ul>
<p>一组水印图，目前仅支持sail.Format.FORMAT_ARGB_PACKED格式</p>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><p>ret: int</p></li>
</ul>
<p>成功后返回0。</p>
<p><strong>注：</strong></p>
<p>需要自行确保overlay_info中的所有矩形位置不重叠</p>
<p><strong>示例代码1:</strong></p>
<p>直接读入RGBA图片作为水印</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="s2">&quot;pics/1.jpg&quot;</span><span class="p">)</span>
    <span class="n">image_org</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="n">buffer</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;pics/icon.png&quot;</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_UNCHANGED</span><span class="p">)</span>
    <span class="n">buffer_x</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">buffer_y</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">buffer_w</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">buffer_h</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="n">buffer_x1</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">buffer_y1</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">buffer_w1</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="n">buffer_h1</span> <span class="o">=</span> <span class="mi">70</span>

    <span class="n">buffer</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="n">buffer_w</span><span class="p">,</span> <span class="n">buffer_h</span><span class="p">))</span>
    <span class="n">buffer1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="n">buffer_w1</span><span class="p">,</span> <span class="n">buffer_h1</span><span class="p">))</span>

    <span class="n">overlay_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">overlay_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">overlay_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_h</span><span class="p">,</span> <span class="n">buffer_w</span><span class="p">,</span> <span class="n">sail</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">FORMAT_ARGB_PACKED</span><span class="p">,</span> <span class="n">sail</span><span class="o">.</span><span class="n">ImgDtype</span><span class="o">.</span><span class="n">DATA_TYPE_EXT_1N_BYTE</span><span class="p">))</span>
    <span class="n">overlay_info</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">buffer_x</span><span class="p">,</span><span class="n">buffer_y</span><span class="p">,</span><span class="n">buffer_w</span><span class="p">,</span> <span class="n">buffer_h</span><span class="p">])</span>
    <span class="n">overlay_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">buffer1</span><span class="p">,</span> <span class="n">buffer_h1</span><span class="p">,</span> <span class="n">buffer_w1</span><span class="p">,</span> <span class="n">sail</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">FORMAT_ARGB_PACKED</span><span class="p">,</span> <span class="n">sail</span><span class="o">.</span><span class="n">ImgDtype</span><span class="o">.</span><span class="n">DATA_TYPE_EXT_1N_BYTE</span><span class="p">))</span>
    <span class="n">overlay_info</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">buffer_x1</span><span class="p">,</span><span class="n">buffer_y1</span><span class="p">,</span><span class="n">buffer_w1</span><span class="p">,</span> <span class="n">buffer_h1</span><span class="p">])</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">bmcv_overlay</span><span class="p">(</span><span class="n">image_org</span><span class="p">,</span> <span class="n">overlay_info</span><span class="p">,</span> <span class="n">overlay_images</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&quot;overlayed.jpg&quot;</span><span class="p">,</span> <span class="n">image_org</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>示例代码2:</strong></p>
<p>用其他库生成中文字的水印图，用overlay画在指定位置，间接实现puttext功能</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># 获取原图</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="s2">&quot;pics/1.jpg&quot;</span><span class="p">)</span>
    <span class="n">org_image</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="c1"># 字体基本信息</span>
    <span class="n">watermark_w</span><span class="p">,</span> <span class="n">watermark_h</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">30</span>
    <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;人&quot;</span><span class="p">,</span> <span class="s2">&quot;车&quot;</span><span class="p">,</span> <span class="s2">&quot;狗&quot;</span><span class="p">]</span>
    <span class="n">text_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="s2">&quot;fonts/simhei.ttf&quot;</span><span class="p">,</span> <span class="n">watermark_h</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="c1"># 生成标签水印图</span>
    <span class="n">overlay_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)):</span>
        <span class="n">blank_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">watermark_w</span><span class="p">,</span> <span class="n">watermark_h</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">blank_image</span><span class="p">)</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="n">text_color</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
        <span class="c1"># blank_image.save(&quot;watermark.png&quot;)</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">blank_image</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
        <span class="n">overlay_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sail</span><span class="o">.</span><span class="n">BMImage</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">watermark_h</span><span class="p">,</span> <span class="n">watermark_w</span><span class="p">,</span> <span class="n">sail</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">FORMAT_ARGB_PACKED</span><span class="p">,</span> <span class="n">sail</span><span class="o">.</span><span class="n">ImgDtype</span><span class="o">.</span><span class="n">DATA_TYPE_EXT_1N_BYTE</span><span class="p">))</span>

    <span class="c1"># 经过推理等其他过程</span>
    <span class="c1"># 模拟获得的水印图位置</span>
    <span class="n">overlay_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">org_image</span><span class="o">.</span><span class="n">width</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">org_image</span><span class="o">.</span><span class="n">height</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">overlay_info</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">watermark_w</span><span class="p">,</span> <span class="n">watermark_h</span><span class="p">])</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">bmcv_overlay</span><span class="p">(</span><span class="n">org_image</span><span class="p">,</span> <span class="n">overlay_info</span><span class="p">,</span> <span class="n">overlay_images</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&quot;overlayed.jpg&quot;</span><span class="p">,</span> <span class="n">org_image</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="faiss-indexflatl2">
<h2><span class="section-number">5.8.47. </span>faiss_indexflatL2<a class="headerlink" href="#faiss-indexflatl2" title="Link to this heading"></a></h2>
<p>计算查询向量与数据库向量 L2 距离的平方, 输出前 topK 个最匹配的 L2 距离的平方值及其对应的索引。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">faiss_indexflatL2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">query_vecs_L2norm</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">database_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">database_vecs_L2norm</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">vec_dims</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">query_vecs_nums</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">database_vecs_nums</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">topK</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>

<span class="n">faiss_indexflatL2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">query_vecs_L2norm</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">database_vecs</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">database_vecs_L2norm</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
                <span class="n">vec_dims</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">query_vecs_nums</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">database_vecs_nums</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">topK</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>query_vecs: numpy.ndarray</dt><dd><p>查询向量, 数据类型仅支持numpy.float32。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>query_vecs_L2norm: numpy.ndarray</dt><dd><p>计算查询向量每行各元素平方值的和, numpy.float32。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>database_vecs: numpy.ndarray 或者 Tensor</dt><dd><p>数据库向量, 数据类型仅支持numpy.float32或者sail.Dtype.BM_FLOAT32。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>database_vecs_L2norm: numpy.ndarray 或者 Tensor</dt><dd><p>计算数据库向量每行各元素平方值的和, numpy.float32 或者sail.Dtype.BM_FLOAT32。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>vec_dims: int</dt><dd><p>查询向量和数据库向量的维度。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>query_vecs_nums: int</dt><dd><p>查询向量的个数。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>database_vecs_nums: int</dt><dd><p>数据库向量的个数。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>topK: int</dt><dd><p>输出前 topK 个最匹配的 L2 距离的平方值及其对应的索引。</p>
</dd>
</dl>
</li>
</ul>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>result: tuple[numpy.ndarray, numpy.ndarray]</dt><dd><p>返回前 topK 个最匹配的 L2 距离的平方值及其对应的索引。</p>
</dd>
</dl>
</li>
</ul>
<dl>
<dt><strong>示例代码1:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># 1. database_vecs</span>
    <span class="n">db_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">],</span>
    <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># 2. query_vecs</span>
    <span class="n">query_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
    <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>

    <span class="c1"># 3. test bmcv.faiss_indexflatL2</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="n">db_vecs_square</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">db_vecs</span><span class="p">)</span>
    <span class="n">db_vecs_l2norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">db_vecs_square</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;db_vecs_l2norm:&quot;</span><span class="p">,</span> <span class="n">db_vecs_l2norm</span><span class="p">)</span>

    <span class="n">query_vecs_square</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">query_vecs</span><span class="p">)</span>
    <span class="n">query_vecs_l2norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">query_vecs_square</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;query_vecs_l2norm:&quot;</span><span class="p">,</span> <span class="n">query_vecs_l2norm</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">similarity_L2</span><span class="p">,</span> <span class="n">index_L2</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">faiss_indexflatL2</span><span class="p">(</span><span class="n">query_vecs</span><span class="p">,</span> <span class="n">query_vecs_l2norm</span><span class="p">,</span> <span class="n">db_vecs</span><span class="p">,</span> <span class="n">db_vecs_l2norm</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">execution_time_milliseconds_L2</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Execution time: </span><span class="si">{</span><span class="n">execution_time_milliseconds_L2</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> milliseconds&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;similarity_L2:&quot;</span><span class="p">,</span> <span class="n">similarity_L2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;index_L2:&quot;</span><span class="p">,</span> <span class="n">index_L2</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt><strong>示例代码2:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># 1. database_vecs</span>
    <span class="n">db_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">],</span>
    <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># 2. query_vecs</span>
    <span class="n">query_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
    <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>

    <span class="c1"># 3. test bmcv.faiss_indexflatL2</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="n">db_vecs_square</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">db_vecs</span><span class="p">)</span>
    <span class="n">db_vecs_l2norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">db_vecs_square</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;db_vecs_l2norm:&quot;</span><span class="p">,</span> <span class="n">db_vecs_l2norm</span><span class="p">)</span>

    <span class="n">query_vecs_square</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">query_vecs</span><span class="p">)</span>
    <span class="n">query_vecs_l2norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">query_vecs_square</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;query_vecs_l2norm:&quot;</span><span class="p">,</span> <span class="n">query_vecs_l2norm</span><span class="p">)</span>

    <span class="c1"># 4. database_vecs and db_vecs_l2norm to sail::Tensor</span>
    <span class="n">db_tensor</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">db_vecs</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">db_tensor_l2norm</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">db_vecs_l2norm</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">similarity_L2</span><span class="p">,</span> <span class="n">index_L2</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">faiss_indexflatL2</span><span class="p">(</span><span class="n">query_vecs</span><span class="p">,</span> <span class="n">query_vecs_l2norm</span><span class="p">,</span> <span class="n">db_tensor</span><span class="p">,</span> <span class="n">db_tensor_l2norm</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">execution_time_milliseconds_L2</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Execution time: </span><span class="si">{</span><span class="n">execution_time_milliseconds_L2</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> milliseconds&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;similarity_L2:&quot;</span><span class="p">,</span> <span class="n">similarity_L2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;index_L2:&quot;</span><span class="p">,</span> <span class="n">index_L2</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="faiss-indexflatip">
<h2><span class="section-number">5.8.48. </span>faiss_indexflatIP<a class="headerlink" href="#faiss-indexflatip" title="Link to this heading"></a></h2>
<p>计算查询向量与数据库向量的内积距离, 输出前 topK 个最匹配的内积距离值及其对应的索引。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">faiss_indexflatIP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">database_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">vec_dims</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">query_vecs_nums</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">database_vecs_nums</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">topK</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>

<span class="n">faiss_indexflatIP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">database_vecs</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
                <span class="n">vec_dims</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">query_vecs_nums</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">database_vecs_nums</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">topK</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>query_vecs: numpy.ndarray</dt><dd><p>查询向量, 数据类型仅支持numpy.float32。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>database_vecs: numpy.ndarray 或者 Tensor</dt><dd><p>数据库向量, 数据类型仅支持numpy.float32或者sail.Dtype.BM_FLOAT32。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>vec_dims: int</dt><dd><p>查询向量和数据库向量的维度。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>query_vecs_nums: int</dt><dd><p>查询向量的个数。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>database_vecs_nums: int</dt><dd><p>数据库向量的个数。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>topK: int</dt><dd><p>输出前 topK 个最匹配的内积距离值及其对应的索引。</p>
</dd>
</dl>
</li>
</ul>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>result: tuple[numpy.ndarray, numpy.ndarray]</dt><dd><p>输出前 topK 个最匹配的内积距离值及其对应的索引。</p>
</dd>
</dl>
</li>
</ul>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># 1. database_vecs</span>
    <span class="n">db_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">],</span>
    <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># 2. query_vecs</span>
    <span class="n">query_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
    <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>

    <span class="c1"># 3. test bmcv.faiss_indexflatIP</span>
    <span class="n">tpu_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">tpu_id</span><span class="p">)</span>
    <span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="n">db_tensor</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">db_vecs</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">similarity_IP</span><span class="p">,</span> <span class="n">index_IP</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">faiss_indexflatIP</span><span class="p">(</span><span class="n">query_vecs</span><span class="p">,</span> <span class="n">db_tensor</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># similarity_IP, index_IP = bmcv.faiss_indexflatIP(query_vecs, db_vecs, 3, 1, 5, 3)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">execution_time_milliseconds_L2</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Execution time: </span><span class="si">{</span><span class="n">execution_time_milliseconds_L2</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> milliseconds&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;similarity_IP:&quot;</span><span class="p">,</span> <span class="n">similarity_IP</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;index_IP:&quot;</span><span class="p">,</span> <span class="n">index_IP</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="faiss-indexpq-encode">
<h2><span class="section-number">5.8.49. </span>faiss_indexPQ_encode<a class="headerlink" href="#faiss-indexpq-encode" title="Link to this heading"></a></h2>
<p>对输入向量进行PQ量化编码, 输出编码之后的向量。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">faiss_indexPQ_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_vecs</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">centroids_vecs</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
                <span class="n">encode_vecs_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">vec_dims</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">centroids_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">IP_metric</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>

<span class="n">faiss_indexPQ_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">centroids_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">encode_vecs_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">vec_dims</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">centroids_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">IP_metric</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="n">faiss_indexPQ_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">centroids_vecs</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">encoded_vecs</span><span class="p">:</span> <span class="n">Tensor</span>
                <span class="n">encode_vecs_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">vec_dims</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">centroids_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">IP_metric</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>input_vecs: numpy.ndarray or Tensor</dt><dd><p>输入的待编码向量, 数据类型仅支持numpy.float32或者sail.Dtype.BM_FLOAT32, 大小为encode_vecs_num * vec_dims。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>centroids_vecs: numpy.ndarray 或者 Tensor</dt><dd><p>聚类中心 (质心) 向量, 数据类型仅支持numpy.float32或者sail.Dtype.BM_FLOAT32, 大小为slice_num * centroids_num * (vec_dims / slice_num)。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>encode_vecs_num: int</dt><dd><p>待编码向量的个数。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>vec_dims: int</dt><dd><p>待编码向量的维度。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>slice_num: int</dt><dd><p>原始向量维度的切分数量, 例如原始向量维度为512, slice_num = 8, 每个子向量维度为64。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>centroids_num: int</dt><dd><p>聚类中心的数量。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>IP_metric: int</dt><dd><p>0 表示使用L2计算距离, 1 表示使用IP计算距离。</p>
</dd>
</dl>
</li>
</ul>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>result: numpy.ndarray 或者 Tensor</dt><dd><p>输出编码之后的向量, numpy.ndarray (uint8) 或者 Tensor (BM_UINT8)。</p>
</dd>
</dl>
</li>
</ul>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">faiss</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="n">encode_vecs_num</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">vec_dims</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">db_vecs_num</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">slice_num</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">centroids_num</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">nbits</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">666</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">db_vecs_num</span><span class="p">,</span> <span class="n">vec_dims</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<span class="n">pq</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">ProductQuantizer</span><span class="p">(</span><span class="n">vec_dims</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">,</span> <span class="n">nbits</span><span class="p">)</span>
<span class="n">pq</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># get centroids</span>
<span class="n">centroids</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">vector_float_to_array</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">centroids</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;centroids.shape: &#39;</span><span class="p">,</span> <span class="n">centroids</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;pq_centroids_random.npy&#39;</span><span class="p">,</span> <span class="n">centroids</span><span class="p">)</span>

<span class="c1"># faiss PQ encode</span>
<span class="n">input_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">encode_vecs_num</span><span class="p">,</span> <span class="n">vec_dims</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<span class="n">faiss_PQ_encode</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">compute_codes</span><span class="p">(</span><span class="n">input_vector</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;faiss_PQ_encode:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">faiss_PQ_encode</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;faiss_PQ_encode shape:&#39;</span><span class="p">,</span> <span class="n">faiss_PQ_encode</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># test sail bmcv.faiss_indexPQ_encode</span>
<span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<span class="n">centroids_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;pq_centroids_random.npy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;centroids_vecs shape:&quot;</span><span class="p">,</span> <span class="n">centroids_vecs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;centroids_vecs dtype:&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">centroids_vecs</span><span class="p">))</span>

<span class="n">input_tensor</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">input_vector</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">centroids_tensor</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">centroids_vecs</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<span class="n">encode_tensor</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">faiss_indexPQ_encode</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">,</span> <span class="n">centroids_tensor</span><span class="p">,</span> <span class="n">encode_vecs_num</span><span class="p">,</span> <span class="n">vec_dims</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">,</span> <span class="n">centroids_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bmcv_faiss_indexPQ_encode:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encode_tensor</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>

<span class="n">encode</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">faiss_indexPQ_encode</span><span class="p">(</span><span class="n">input_vector</span><span class="p">,</span> <span class="n">centroids_vecs</span><span class="p">,</span> <span class="n">encode_vecs_num</span><span class="p">,</span> <span class="n">vec_dims</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">,</span> <span class="n">centroids_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bmcv_faiss_indexPQ_encode:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encode</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="faiss-indexpq-adc">
<h2><span class="section-number">5.8.50. </span>faiss_indexPQ_ADC<a class="headerlink" href="#faiss-indexpq-adc" title="Link to this heading"></a></h2>
<p>通过查询向量和聚类中心 (质心) 向量计算出距离表, 编码的数据库向量查表计算距离并排序, 输出前 topK 个最匹配的距离值及其对应的索引。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">faiss_indexPQ_ADC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nxquery_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">centroids_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">nycodes_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">vec_dims</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">centroids_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">database_vecs_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">query_vecs_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">topK</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">IP_metric</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>

<span class="n">faiss_indexPQ_ADC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nxquery_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">centroids_vecs</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">nycodes_vecs</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
                <span class="n">vec_dims</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">centroids_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">database_vecs_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">query_vecs_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">topK</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">IP_metric</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>nxquery_vecs: numpy.ndarray</dt><dd><p>查询向量, 数据类型仅支持numpy.float32, 大小为query_vecs_nums * vec_dims。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>centroids_vecs: numpy.ndarray 或者 Tensor</dt><dd><p>聚类中心 (质心) 向量, 数据类型仅支持numpy.float32 或者sail.Dtype.BM_FLOAT32, 大小为slice_num * centroids_num * (vec_dims / slice_num)。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>nycodes_vecs: numpy.ndarray 或者 Tensor</dt><dd><p>编码的数据库向量, 数据类型仅支持numpy.uint8 或者sail.Dtype.BM_UINT8, 大小为database_vecs_nums * slice_num。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>vec_dims: int</dt><dd><p>查询向量的维度。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>slice_num: int</dt><dd><p>原始向量维度的切分数量, 例如原始向量维度为512, slice_num = 8, 每个子向量维度为64。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>centroids_num: int</dt><dd><p>聚类中心 (质心) 向量的个数。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>database_vecs_nums: int</dt><dd><p>数据库向量的个数。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>query_vecs_nums: int</dt><dd><p>查询向量的个数。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>topK: int</dt><dd><p>输出前 topK 个最匹配的距离值及其对应的索引。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>IP_metric: int</dt><dd><p>0 表示使用L2计算距离, 1 表示使用IP计算距离。</p>
</dd>
</dl>
</li>
</ul>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>result: tuple[numpy.ndarray, numpy.ndarray]</dt><dd><p>输出前 topK 个最匹配的距离值及其对应的索引。</p>
</dd>
</dl>
</li>
</ul>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">faiss</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">vec_dims</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">database_vecs_num</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">query_vecs_num</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">nydb_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">database_vecs_num</span><span class="p">,</span> <span class="n">vec_dims</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<span class="n">nxquery_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">query_vecs_num</span><span class="p">,</span> <span class="n">vec_dims</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

<span class="n">slice_num</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">n_bits</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexPQ</span><span class="p">(</span><span class="n">vec_dims</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">,</span> <span class="n">n_bits</span><span class="p">)</span>
<span class="n">index</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">nydb_vecs</span><span class="p">)</span>
<span class="n">index</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nydb_vecs</span><span class="p">)</span>

<span class="c1"># save centroids</span>
<span class="n">centroids_faiss</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">pq</span><span class="o">.</span><span class="n">centroids</span>
<span class="n">centroids</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">vector_float_to_array</span><span class="p">(</span><span class="n">centroids_faiss</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;centroids.shape: &#39;</span><span class="p">,</span> <span class="n">centroids</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;centroids_random.npy&#39;</span><span class="p">,</span> <span class="n">centroids</span><span class="p">)</span>

<span class="c1"># Compute PQ codes for the database vectors and save</span>
<span class="n">db_codes</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">pq</span><span class="o">.</span><span class="n">compute_codes</span><span class="p">(</span><span class="n">nydb_vecs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;db_codes.shape:&#39;</span><span class="p">,</span> <span class="n">db_codes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;db_codes.npy&#39;</span><span class="p">,</span> <span class="n">db_codes</span><span class="p">)</span>

<span class="c1"># faiss</span>
<span class="n">D</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">nxquery_vecs</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The index of faiss:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The distance of faiss:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>

<span class="c1"># test faiss_indexPQ_ADC of sail</span>
<span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<span class="c1"># get centroids</span>
<span class="n">centroids_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;centroids_random.npy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;centroids_vecs shape:&quot;</span><span class="p">,</span> <span class="n">centroids_vecs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;centroids_vecs dtype:&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">centroids_vecs</span><span class="p">))</span>
<span class="c1"># get PQ codes for the database vectors</span>
<span class="n">nycodes_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;db_codes.npy&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nycodes_vecs shape:&quot;</span><span class="p">,</span> <span class="n">nycodes_vecs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nycodes_vecs dtype:&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">nycodes_vecs</span><span class="p">))</span>

<span class="c1"># to tensor</span>
<span class="n">centroids_tensor</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">centroids_vecs</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">nycode_tensor</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">nycodes_vecs</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<span class="c1"># D_, I_ = bmcv.faiss_indexPQ_ADC(nxquery_vecs, centroids_tensor, nycode_tensor, vec_dims, slice_num, 256, database_vecs_num, query_vecs_num, 5, 0)</span>
<span class="n">D_</span><span class="p">,</span> <span class="n">I_</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">faiss_indexPQ_ADC</span><span class="p">(</span><span class="n">nxquery_vecs</span><span class="p">,</span> <span class="n">centroids_vecs</span><span class="p">,</span> <span class="n">nycodes_vecs</span><span class="p">,</span> <span class="n">vec_dims</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">database_vecs_num</span><span class="p">,</span> <span class="n">query_vecs_num</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The index of sail:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">I_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The distance of sail:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">D_</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="faiss-indexpq-sdc">
<h2><span class="section-number">5.8.51. </span>faiss_indexPQ_SDC<a class="headerlink" href="#faiss-indexpq-sdc" title="Link to this heading"></a></h2>
<p>使用SDC (Symmetric Distance Computation, 对称距离计算)查找表加速 PQ 编码之间的距离计算, 输出与查询向量前 topK 个最匹配的距离值及其对应的索引。</p>
<dl>
<dt><strong>接口形式:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">faiss_indexPQ_SDC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nxcodes_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">nycodes_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sdc_table</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">slice_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">centroids_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">database_vecs_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">query_vecs_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">topK</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">IP_metric</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>

<span class="n">faiss_indexPQ_SDC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nxcodes_vecs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">nycodes_vecs</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">sdc_table</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
                <span class="n">slice_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">centroids_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">database_vecs_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">query_vecs_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">topK</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">IP_metric</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</pre></div>
</div>
</dd>
</dl>
<p><strong>参数说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>nxcodes_vecs: numpy.ndarray</dt><dd><p>编码的查询向量, 数据类型仅支持numpy.uint8, 大小为query_vecs_nums * slice_num。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>nycodes_vecs: numpy.ndarray 或者 Tensor</dt><dd><p>编码的数据库向量, 数据类型仅支持numpy.uint8 或者sail.Dtype.BM_UINT8, 大小为database_vecs_nums * slice_num。</p>
</dd>
</dl>
</li>
</ul>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>sdc_table: numpy.ndarray 或者 Tensor</dt><dd><p>sdc对称距离表, 数据类型仅支持numpy.float32 或者sail.Dtype.BM_FLOAT32, 大小为slice_num * centroids_num * centroids_num。</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>slice_num: int</dt><dd><p>原始向量维度的切分数量, 例如原始向量维度为512, slice_num = 8, 每个子向量维度为64。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>centroids_num: int</dt><dd><p>聚类中心 (质心) 向量的个数。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>database_vecs_nums: int</dt><dd><p>数据库向量的个数。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>query_vecs_nums: int</dt><dd><p>查询向量的个数。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>topK: int</dt><dd><p>输出前 topK 个最匹配的距离值及其对应的索引。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>IP_metric: int</dt><dd><p>0 表示使用L2计算距离, 1 表示使用IP计算距离。</p>
</dd>
</dl>
</li>
</ul>
<p><strong>返回值说明:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>result: tuple[numpy.ndarray, numpy.ndarray]</dt><dd><p>输出前 topK 个最匹配的距离值及其对应的索引。</p>
</dd>
</dl>
</li>
</ul>
<dl>
<dt><strong>示例代码:</strong></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">faiss</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sophon.sail</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sail</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">vec_dims</span> <span class="o">=</span> <span class="mi">512</span>             <span class="c1"># The dimension of the vectors.</span>
<span class="n">database_vecs_num</span> <span class="o">=</span> <span class="mi">10000</span>  <span class="c1"># The number of the database vectors.</span>
<span class="n">query_vecs_num</span> <span class="o">=</span> <span class="mi">1</span>         <span class="c1"># The number of the query vectors.</span>

<span class="c1"># 1. Random database and query</span>
<span class="n">database</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">database_vecs_num</span><span class="p">,</span> <span class="n">vec_dims</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">query_vecs_num</span><span class="p">,</span> <span class="n">vec_dims</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

<span class="c1"># 2. The parameters of PQ</span>
<span class="n">slice_num</span> <span class="o">=</span> <span class="mi">8</span>       <span class="c1"># Divide the vector of the vec_dims dimension into 8 subvectors</span>
<span class="n">n_bits</span> <span class="o">=</span> <span class="mi">8</span>          <span class="c1"># centroids = 256 = 2^n_bits</span>

<span class="c1"># 3. Create a PQ index</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexPQ</span><span class="p">(</span><span class="n">vec_dims</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">,</span> <span class="n">n_bits</span><span class="p">)</span>
<span class="n">index</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>  <span class="c1"># Train the PQ index</span>
<span class="n">index</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>

<span class="c1"># 4. Set to SDC (Symmetric Distance Calculation)</span>
<span class="n">index</span><span class="o">.</span><span class="n">search_type</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">IndexPQ</span><span class="o">.</span><span class="n">ST_SDC</span>

<span class="c1"># 5. Calculate sdc_table and save it</span>
<span class="n">index</span><span class="o">.</span><span class="n">pq</span><span class="o">.</span><span class="n">compute_sdc_table</span><span class="p">()</span>

<span class="n">sdc_table</span> <span class="o">=</span> <span class="n">faiss</span><span class="o">.</span><span class="n">vector_float_to_array</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">pq</span><span class="o">.</span><span class="n">sdc_table</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sdc_table shape:&#39;</span><span class="p">,</span> <span class="n">sdc_table</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;sdc_table.npy&#39;</span><span class="p">,</span> <span class="n">sdc_table</span><span class="p">)</span>

<span class="c1"># 6. Query operations using faiss</span>
<span class="n">topK</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">D</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">topK</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The index of faiss:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The distance of faiss:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>

<span class="c1"># Calculate and save the PQ encoding of the database vector (for sail test)</span>
<span class="n">db_codes</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">pq</span><span class="o">.</span><span class="n">compute_codes</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;db_codes.shape:&#39;</span><span class="p">,</span> <span class="n">db_codes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;db_codes.npy&#39;</span><span class="p">,</span> <span class="n">db_codes</span><span class="p">)</span>

<span class="c1"># Calculate and save the PQ encoding of the query vectors (for sail test)</span>
<span class="n">query_code</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">pq</span><span class="o">.</span><span class="n">compute_codes</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;query_code.shape:&#39;</span><span class="p">,</span> <span class="n">query_code</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;query_code.npy&#39;</span><span class="p">,</span> <span class="n">query_code</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;________________________________________________________________________________&quot;</span><span class="p">)</span>

<span class="c1"># test faiss_indexPQ_SDC</span>
<span class="n">handle</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">bmcv</span> <span class="o">=</span> <span class="n">sail</span><span class="o">.</span><span class="n">Bmcv</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<span class="c1"># 1. get PQ codes of the database vectors</span>
<span class="n">nycodes_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;db_codes.npy&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nycodes_vecs shape:&quot;</span><span class="p">,</span> <span class="n">nycodes_vecs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nycodes_vecs dtype:&quot;</span><span class="p">,</span> <span class="n">nycodes_vecs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

<span class="c1"># 2. get PQ codes of the query vectors</span>
<span class="n">nxcodes_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;query_code.npy&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nxcodes_vecs shape:&quot;</span><span class="p">,</span> <span class="n">nxcodes_vecs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nxcodes_vecs dtype:&quot;</span><span class="p">,</span> <span class="n">nxcodes_vecs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

<span class="c1"># 3. get the SDC table</span>
<span class="n">SDC_tables</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;sdc_table.npy&#39;</span><span class="p">)</span>

<span class="n">D_</span><span class="p">,</span> <span class="n">I_</span> <span class="o">=</span> <span class="n">bmcv</span><span class="o">.</span><span class="n">faiss_indexPQ_SDC</span><span class="p">(</span><span class="n">nxcodes_vecs</span><span class="p">,</span> <span class="n">nycodes_vecs</span><span class="p">,</span> <span class="n">SDC_tables</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">database_vecs_num</span><span class="p">,</span> <span class="n">query_vecs_num</span><span class="p">,</span> <span class="n">topK</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The index of sail:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">I_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The distance of sail:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">D_</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="sail.BMImage.html" class="btn btn-neutral float-left" title="5.7. sail.BMImage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="sail.Decoder.html" class="btn btn-neutral float-right" title="5.9. sail.Decoder" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, SOPHGO。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>